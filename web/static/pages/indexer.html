<script type="text/javascript" src="/static/libs/jquery.json.js"></script>

<div class="container-xl">
  <!-- Page title -->
  <div class="page-header d-print-none mt-2">
    <div class="row align-items-center">
      <div class="col">
        <h2 class="page-title">BT索引</h2>
        <input type="hidden" id="is_public_site" value="1" />
      </div>
      <!-- Page title actions -->
      <div class="col-auto ms-auto d-print-none">
        <div class="btn-list">
          <a href="javascript:add_indexer()" class="btn btn-primary d-none d-sm-inline-flex">
            <i class="ti ti-plus fs-3"></i>
            新增站点
          </a>
          <a href="javascript:add_indexer()" class="btn btn-primary d-sm-none mbtn-action">
            <i class="ti ti-plus fs-3"></i>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="container-xl" id="indexers-container" style="display: none;">
  <div id="public-indexer-div" class="page-body tab-pane fade active show" role="tabpanel">
    <div class="d-grid gap-3 grid-info-card" id="indexers-list">
    </div>
  </div>
</div>

<nodata-found id="no-indexers" title="没有数据" text="没有可以用的索引站点" style="display: none;"></nodata-found>

<script type="text/javascript">

  var check_sites = [];

  // 新增站点
  function add_indexer(site_url) {

    $("#modal-manual-indexer").data("indexer", NaN);

    $("#indexer_id").val("").attr("readonly", false);
    $("#indexer_name").val("").attr("readonly", false);
    $("#indexer_url").val("")

    $("#indexer_download_setting").val(0);
    $('parser_setting').val("");
    $('search_type').val("title");

    select_SelectALL(true, "source_type")

    $('#search_cfg').val("");
    $('#torrent_cfg').val("");
    $('browse_cfg').val("");
    $('category_cfg').val("");

    $("#indexer_modal_title").text("新增索引站点");
    $("[name='indexer_add_btn']").show();
    $("[name='indexer_edit_btn']").hide();

    $("#modal-manual-indexer").modal("show");
  }

  function do_add_indexer() {

    var search_cfg = $('#search_cfg').val();
    if (!object_json_valid(search_cfg, false)) {
      show_fail_modal('搜索配置不合法，请检查后重试');
      return
    }

    var torrent_cfg = $('#torrent_cfg').val();
    if (!object_json_valid(torrent_cfg, false)) {
      show_fail_modal('种子过滤配置不合法，请检查后重试');
      return
    }

    var browse_cfg = $('#browse_cfg').val();
    if (!object_json_valid(browse_cfg, true)) {
      show_fail_modal('资源浏览配置不合法，请检查后重试');
      return
    }

    var category_cfg = $('#category_cfg').val();
    if (!object_json_valid(category_cfg, true)) {
      show_fail_modal('目录配置不合法，请检查后重试');
      return
    }

    const data = {
      "id": $("#indexer_id").val(),
      "name": $("#indexer_name").val(),
      "domain": $("#indexer_url").val(),
      "proxy": $('#indexer_proxy').prop('checked'),
      "render": $('#indexer_render').prop('checked'),
      "en_expand": $('#en_expand').prop('checked'),
      "downloader": $("#indexer_download_setting").val(),
      "parser": $('#parser_setting').val(),
      "source_type": select_GetSelectedVAL("source_type").join(','),
      "search_type": $('#search_type').val(),
      "search": search_cfg,
      "torrents": torrent_cfg,
      "browse": browse_cfg,
      "category": category_cfg,
      "public": $('#is_public_site').val()
    };

    axios_post_do("add_indexer", data, function (ret) {
      if (ret.code === 0) {
        $("#modal-manual-indexer").modal("hide");
        show_success_modal("添加索引站点成功!");
        window_history_refresh();
      } else {
        show_fail_modal(`添加索引站点失败：${ret.msg}!`);
      }
    });

  };

  function do_del_indexer(indexer_id, indexer_name) {

    show_ask_modal("是否确认删除索引站点 " + indexer_name + " ?", function () {

      hide_ask_modal();

      const data = {
        "id": indexer_id
      };

      axios_post_do("delete_indexer", data, function (ret) {
        if (ret.code === 0) {
          $("#modal-manual-indexer").modal("hide");
          window_history_refresh();
        } else {
          show_fail_modal(`索引站点删除失败：${ret.msg}!`);
        }
      });
      
    });

  };

  $(document).ready(function () {

    const container = document.getElementById("page_content");
    const urlParams = $(container).data("params");
    var pParam = urlParams.p || 1;

    const indexersList = $('#indexers-list');
    indexersList.empty();

    axios_post('/data/indexer?p=' + pParam, {}, function(response) {
     
      if (response.code === 0 && response.data) {
        
        const data = response.data;

        // 设置是否为公共站点
        $('#is_public_site').val(data.isPublic);

        // 更新全局变量
        if (data.checkSites) {
          check_sites = data.checkSites;
        }

        // 生成索引站点列表
        if (data.indexers && data.indexers.length > 0) {

          data.indexers.forEach(site => {
            // 生成资源类型标签
            let sourceTypeBadges = '';
            if (site.source_type && Array.isArray(site.source_type)) {
              sourceTypeBadges = site.source_type.map(source => {
                const sourceStr = source.toString();
                const sourceLabel = data.sourceTypes && data.sourceTypes[sourceStr] ?
                  data.sourceTypes[sourceStr] : source;
                return `<span class="badge bg-blue me-2">${sourceLabel}</span>`;
              }).join('');
            }

            // 生成下载器标签
            let downloaderBadge = '<span class="badge bg-yellow me-2">默认</span>';
            if (site.downloader && data.downloadSettings && data.downloadSettings[site.downloader.toString()]) {
              downloaderBadge = `<span class="badge bg-yellow me-2">${data.downloadSettings[site.downloader.toString()]}</span>`;
            }

            // 生成特性标签
            let featureBadges = '';
            if (site.render) featureBadges += '<span class="badge bg-yellow-lt mb-1 me-1">仿真</span>';
            if (site.proxy) featureBadges += '<span class="badge bg-lime-lt mb-1 me-1">代理</span>';
            if (site.en_expand) featureBadges += '<span class="badge bg-cyan-lt mb-1 me-1">扩展</span>';

            const siteCard = `
              <div class="card glass-card">
                <div class="card-header">
                  <div class="form-switch">
                    <input name="indexer_sites" type="checkbox" class="form-check-input" value="${site.id}" ${site.checked ? 'checked' : ''}>
                  </div>
                  <span class="text-reset card-text">${site.name}</span>
                  <div class="card-actions btn-actions">
                    <a href="javascript:edit_indexer_conf('${site.domain}')" class="btn-action ms-1" title="编辑站点">
                      <i class="ti ti-edit fs-2"></i>
                    </a>
                    <a href="javascript:do_del_indexer('${site.id}', '${site.name}')" class="btn btn-link text-red me-auto" title="删除站点">
                      <i class="ti ti-x fs-2"></i>
                    </a>
                  </div>
                </div>
                <div class="card-body">
                  <dl class="row">
                    <dt class="col-3">站点地址:</dt>
                    <dd class="col-9"><a href="${site.domain}" target="_blank">${site.domain}</a></dd>
                    <dt class="col-3">资源类型:</dt>
                    <dd class="col-9">${sourceTypeBadges}</dd>
                    <dt class="col-3">搜索方式:</dt>
                    <dd class="col-9">
                      <span class="badge bg-lime me-2">${site.search_type}</span>
                    </dd>
                    <dt class="col-3">下载器:</dt>
                    <dd class="col-9">${downloaderBadge}</dd>
                  </dl>
                  <div class="row">
                    <div class="col">
                      ${featureBadges}
                    </div>
                  </div>
                </div>
              </div>
            `;
            indexersList.append(siteCard);
          });

          $('#indexers-container').show();
          $('#no-indexers').hide();

          
          // 监听站点启用
          $('input[name="indexer_sites"]').change(function () {
            const itemVal = $(this).val();

            if (this.checked) {
                check_sites.push(itemVal)
            } else {
                const indexToRemove = check_sites.indexOf(itemVal);
                if (indexToRemove > -1) {
                  check_sites.splice(indexToRemove, 1);
                }
            }

            let params = {
              key: "UserIndexerSites",
              value: check_sites
            }
            axios_post_do("set_system_config", params);
            
          });

        } else {
          $('#indexers-container').hide();
          const noIndexersElement = $('#no-indexers');
          if (data.isPublic == 1) {
            noIndexersElement.attr('text', '没有可以用的公共索引站点');
          } else {
            noIndexersElement.attr('text', '没有认证成功的PT站点信息');
          }
          noIndexersElement.show();
        }
      }
    }, true, true);
  });

</script>