<!-- 业务页面代码 -->
<div class="card components-div" id="sys_config">
  <div class="card border-0">
    <div class="card-header" style="display: flex; align-items: center;">
      <h4 class="card-title"><strong>基础设置</strong></h4>
      <div class="card-actions btn-actions">
        <a href="javascript:slideToggle('basic_system')" class="btn-action ms-1" title="展开/折叠">
          <i class="ti ti-menu-2 fs-2"></i>
        </a>
      </div>
    </div>
    <div class="card-body border-bottom" id="basic_system">
      <div class="row">
        <div class="col-lg">
          <div class="mb-3">
            <label class="form-label required">WEB服务端口</label>
            <input type="text" value="" class="form-control" id="app.web_port"
              placeholder="3000" autocomplete="off">
          </div>
        </div>
        <div class="col-lg">
          <div class="mb-3">
            <label class="form-label required">WEB管理用户</label>
            <input type="text" value="" class="form-control" id="app.login_user"
              placeholder="admin" autocomplete="off">
          </div>
        </div>
        <div class="col-lg">
          <div class="mb-3">
            <label class="form-label required">WEB管理密码</label>
            <input type="password" value="" class="form-control"
              id="app.login_password" placeholder="password" autocomplete="off">
          </div>
        </div>
        <div class="col-lg">
          <div class="mb-3">
            <label class="form-label required">WEB壁纸来源 <span class="form-help"
                title="登录界面壁纸来源：TMDB、Bing，设置为TMDB时需在媒体配置TMDB API Key" data-bs-toggle="tooltip">?</span></label>
            <select class="form-select" id="app.wallpaper">
              <option value="themoviedb">
                电影海报
              </option>
              <option value="bing">
                Bing每日壁纸
              </option>
            </select>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-lg">
          <div class="mb-3">
            <label class="form-label">日志级别 <span class="form-help" title="一般情况下请选择INFO，排查问题可选择DEBUG"
                data-bs-toggle="tooltip">?</span></label>
            <select class="form-select" id="app.loglevel">
              <option value="info">
                INFO
              </option>
              <option value="debug">
                DEBUG
              </option>
              <option value="error">
                ERROR
              </option>
            </select>
          </div>
        </div>
        <div class="col-lg">
          <div class="mb-3">
            <label class="form-label required">日志输出类型</label>
            <select class="form-select" id="app.logtype">
              <option value="console">控制台</option>
              <option value="file">文件</option>
              <option value="server">日志中心</option>
            </select>
          </div>
        </div>
        <div class="col-lg">
          <div class="mb-3">
            <label class="form-label">日志文件路径 <span class="form-help" title="日志输出类型为文件时需要配置该项"
                data-bs-toggle="tooltip">?</span></label>
            <input type="text" value="" class="form-control filetree-folders-only"
              id="app.logpath" placeholder="/config/logs" autocomplete="off">
          </div>
        </div>
        <div class="col-lg">
          <div class="mb-3">
            <label class="form-label">日志中心地址 <span class="form-help"
                title="日志输出类型为日志中心时需要配置该项；需要配置IP地址和端口，配置示例：127.0.0.1:514" data-bs-toggle="tooltip">?</span></label>
            <input type="text" value="" class="form-control" id="app.logserver"
              placeholder="127.0.0.1:514" autocomplete="off">
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-12 col-xl-3">
          <div class="mb-3">
            <label class="form-label required">TMDB API Key <span class="form-help"
                title="在themoviedb.org网站申请API Key，该项必须配置，否则所有功能无法正常运行" data-bs-toggle="tooltip">?</span></label>
            <input type="text" value=""
              class="form-control" id="app.rmt_tmdbkey"
              placeholder="" autocomplete="off">
          </div>
        </div>
        <div class="col-12 col-xl-3">
          <div class="mb-3">
            <label class="form-label required">TMDB API Url <span class="form-help"
                title="选择访问TMDB API时使用的地址，api.themoviedb.org、api.tmdb.org为官方地址，其余为使用代理中转，如无法连接TMDB匹配媒体信息时可偿试更换"
                data-bs-toggle="tooltip">?</span></label>
            <select class="form-select" id="app.tmdb_domain">
            </select>
          </div>
        </div>
        <div class="col-12 col-xl-1">
          <div class="mb-3">
            <label class="form-label">TMDB语言 <span class="form-help"
                title="选择TMDB语言，将会影响媒体信息展示、文件整理及刮削等所有涉及使用TMDB数据的内容语言" data-bs-toggle="tooltip">?</span></label>
            <select class="form-select" id="media.tmdb_language">
              <option value="zh">中文</option>
              <option value="en">English</option>
            </select>
          </div>
        </div>
        <div class="col-12 col-xl-2">
          <div class="mb-3">
            <label class="form-label required">TMDB匹配模式 <span class="form-help"
                title="正常模式下会提升识别成功率，但也可能会导致误识别率增加；严格模式可以降低误识别率，但可能导致很多文件名/种子名中年份不正确的无法被识别（特别是剧集，需要是首播年份）"
                data-bs-toggle="tooltip">?</span></label>
            <select class="form-select" id="app.rmt_match_mode">
              <option value="normal">正常模式
              </option>
              <option value="strict">严格模式
              </option>
            </select>
          </div>
        </div>
        <div class="col-12 col-xl-3">
          <div class="mb-3">
            <label class="form-label">TMDB图片代理 <span class="form-help" title="加速TMDB图片下载，留空使用TMDB官方地址"
                data-bs-toggle="tooltip">?</span></label>
            <input type="text" value="" class="form-control" id="app.tmdb_image_url" placeholder="https://image.tmdb.org" autocomplete="off">
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-12 col-xl-3">
          <div class="mb-3">
            <label class="form-label">代理服务器 <span class="form-help"
                title="将使用代理访服务器访问themoviedb、telegram等境外网站及程序更新(git)，站点默认不使用代理，如需使用需在站点维护中开启；配置格式示例：127.0.0.1:7890（Http协议）、socks5://127.0.0.1:8018、socks5h://127.0.0.1:8018(remote DNS)"
                data-bs-toggle="tooltip">?</span></label>
            <input type="text" value="" class="form-control" id="app.proxies" placeholder="127.0.0.1:7890" autocomplete="off">
          </div>
        </div>
        <div class="col-12 col-xl-3">
          <div class="mb-3">
            <label class="form-label">自建OCR服务 <span class="form-help" title="填写后将使用自建的OCR服务进行验证码识别"
                data-bs-toggle="tooltip">?</span></label>
            <div class="input-group input-group-flat">
              <input type="text" value="" class="form-control" id="app.ocr_url" placeholder="http://127.0.0.1:9899/captcha/base64" autocomplete="off">
            </div>
          </div>
        </div>
        <div class="col-12 col-xl-3">
          <div class="mb-3">
            <label class="form-label">外网访问地址 <span class="form-help"
                title="使用该地址进行通知点击跳转以及设置Telegram机器人Webhook；需要配置IP地址和端口，如为https则需要加https://前缀；如启用Telegram机器人Webhook，则端口必须为：443, 80, 88, 8443之一，80、443一般运营商会封禁，建议使用88、8443"
                data-bs-toggle="tooltip">?</span></label>
            <input type="text" value="" class="form-control" id="app.domain" placeholder="http://IP:PORT" autocomplete="off">
          </div>
        </div>
        <div class="col-12 col-xl-3">
          <div class="mb-3">
            <label class="form-label">User-Agent <span class="form-help" title="如发现被豆瓣、PT站等封堵，请适当修改此项" data-bs-toggle="tooltip">?</span></label>
            <div class="input-group input-group-flat">
              <input type="text" value="" class="form-control" id="app.user_agent" autocomplete="off">
              <span class="input-group-text">
                <a href="javascript:set_user_agent('app\\.user_agent')" class="link-secondary" title="从浏览器中获取 User-Agent" data-bs-toggle="tooltip">
                  <i class="ti ti-arrow-bar-to-left fs-2"></i>
                </a>
              </span>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-lg">
          <div class="mb-3">
            <label class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="app.releases_update_only">
              <span class="form-check-label">仅检查Releases更新 <span class="form-help" title="开启后，只有Releases更新，才会有更新提示"
                  data-bs-toggle="tooltip">?</span></span>
            </label>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="card border-0">
    <div class="card-header">
      <h4 class="card-title"><strong>服务配置</strong></h4>
      <div class="card-actions btn-actions">
        <a href="javascript:slideToggle('basic_service')" class="btn-action ms-1" title="展开/折叠">
          <i class="ti ti-menu-2 fs-2"></i>
        </a>
      </div>
    </div>
    <div class="card-body border-bottom" id="basic_service" style="display: none;">
      <div class="row mb-3">
        <div class="d-grid gap-3 grid-normal-card" id="media-server-list">
          <!-- JS 动态填充 -->
        </div>
      </div>
      <div class="row">
        <div class="col-12 col-xl-3">
          <div class="mb-3">
            <label class="form-label">媒体服务器同步周期(小时) <span class="form-help" title="定时同步媒体服务器数据到本地，用于展示媒体是否存在，留空则不启用同步服务"
                data-bs-toggle="tooltip">?</span></label>
            <input type="text" value="" class="form-control"
              id="media.mediasync_interval" placeholder="留空关闭媒体服务器同步" autocomplete="off">
          </div>
        </div>
      </div>
      <hr class="mt-1 mb-3">
      <div class="row">
        <div class="col-lg">
          <div class="mb-3">
            <label class="form-label required">下载优先规则 <span class="form-help"
                title="订阅及远程搜索下载将按此优先规则选择下载资源，其中站点优先决定于维护的站点优先级或索引器中配置的站点顺序，默认为站点优先"
                data-bs-toggle="tooltip">?</span></label>
            <select class="form-select" id="pt.download_order">
              <option value="">默认</option>
              <option value="site">站点优先</option>
              <option value="seeder">做种数优先
              </option>
            </select>
          </div>
        </div>
        <div class="col-lg">
          <div class="mb-3">
            <label class="form-label">订阅RSS周期(秒) <span class="form-help"
                title="RSS订阅刷新的时间间隔，需要在订阅管理中设置订阅站点；如配置为空则不启动RSS订阅功能；为了减小站点压力，最小周期不能小于300秒"
                data-bs-toggle="tooltip">?</span></label>
            <input type="text" value="" class="form-control"
              id="pt.pt_check_interval" placeholder="留空关闭RSS订阅" autocomplete="off">
          </div>
        </div>
        <div class="col-lg">
          <div class="mb-3">
            <label class="form-label">订阅搜索周期(小时) <span class="form-help"
                title="定时对电影/电视剧订阅进行站点存量资源检索下载，用于对RSS订阅进行查漏补缺。以小时为单位，最小间隔为1小时，设置小于1小时时将强制设定为1小时。该项会对站点造成压力，应尽量通过维护站点RSS实现订阅追新，如非必要请不要开启"
                data-bs-toggle="tooltip">?</span></label>
            <input type="text" value="" class="form-control"
              id="pt.search_rss_interval" placeholder="留空关闭订阅定时搜索" autocomplete="off">
          </div>
        </div>
        <div class="col-lg">
          <div class="mb-3">
            <label class="form-label">站点数据刷新时间 <span class="form-help"
                title="站点数据刷新时间，四种配置方法：1、配置间隔，单位小时，比如23.5；2、配置固定时间，如08:00；3、配置时间范围，如08:00-09:00，表示在该时间范围内随机执行一次；4、配置5位cron表达式，如：0 */6 * * *；配置为空则不启用自动站点数据刷新功能。"
                data-bs-toggle="tooltip">?</span></label>
            <input type="text" value="" class="form-control"
              id="pt.ptrefresh_date_cron" placeholder="留空关闭自动刷新" autocomplete="off">
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-12 col-xl-3">
          <div class="mb-3">
            <label class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="pt.search_auto">
              <span class="form-check-label">远程搜索自动择优下载 <span class="form-help"
                  title="启用后在微信、Telegram等发送名称后会按配置的下载优先规则及过滤规则自动择优下载，否则需要点击链接跳转后手工选择；注意关闭后需要先维护好 '外网访问地址'，否则无法点击跳转。"
                  data-bs-toggle="tooltip">?</span></span>
            </label>
          </div>
        </div>
        <div class="col-12 col-xl-3">
          <div class="mb-3">
            <label class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="pt.search_no_result_rss">
              <span class="form-check-label">远程下载不完整自动订阅 <span class="form-help"
                  title="启用后在微信、Telegram发送名称搜索下载不完整时将自动添加订阅" data-bs-toggle="tooltip">?</span></span>
            </label>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="card border-0">
    <div class="card-header">
      <h4 class="card-title"><strong>安全配置</strong></h4>
      <div class="card-actions btn-actions">
        <a href="javascript:slideToggle('security')" class="btn-action ms-1" title="展开/折叠">
          <i class="ti ti-menu-2 fs-2"></i>
        </a>
      </div>
    </div>
    <div class="card-body border-bottom" id="security" style="display: none;">
      <div class="row">
        <div class="form-group">
          <label class="control-label">API密钥 <span class="form-help"
              title="使用Jellyseerr、Overseerr等调用本程序订阅接口时，需要在Authorization中填入该密钥" data-bs-toggle="tooltip">?</span>
          </label>
          <div class="col-sm-11">
            <input type="text" id="security.api_key" class="form-control"
              value="">
          </div>
        </div>
        <div class="form-group">
          <label class="control-label">Webhook白名单 <span class="form-help"
              title="仅允许配置的地址范围内地址调用Webhook，多个地址段用,号分隔，默认为0.0.0.0/0,::/0即不做限制" data-bs-toggle="tooltip">?</span>
          </label>
          <div class="col-sm-11">
            <input type="text" value=""
              class="form-control" id="security.media_server_webhook_allow_ip.ipv4" placeholder="允许的IPv4 CIDR"
              autocomplete="off">
            <input type="text" value=""
              class="form-control" id="security.media_server_webhook_allow_ip.ipv6" placeholder="允许的IPv6 CIDR"
              autocomplete="off">
          </div>
        </div>
        <div class="form-group">
          <label class="control-label">Telegram白名单 <span class="form-help"
              title="仅接收配置的地址范围内发送的Telegram消息，多个地址段用,号分隔，配置为0.0.0.0/0,::/0则不做限制；使用Telegram WebHook且未做代理转发时推荐IPv4地址设置为：149.154.160.0/20,91.108.4.0/22，关闭Telegram WebHook时推荐IPv4地址设置为：127.0.0.1"
              data-bs-toggle="tooltip">?</span>
          </label>
          <div class="col-sm-11">
            <input type="text"
              value=""
              class="form-control" id="security.telegram_webhook_allow_ip.ipv4" placeholder="允许的IPv4 CIDR"
              autocomplete="off">
            <input type="text"
              value=""
              class="form-control" id="security.telegram_webhook_allow_ip.ipv6" placeholder="允许的IPv6 CIDR"
              autocomplete="off">
          </div>
        </div>
        <div class="form-group">
          <label class="control-label">Synology Chat白名单 <span class="form-help"
              title="仅接收配置的地址范围内发送的Synology Chat消息，多个地址段用,号分隔，配置为0.0.0.0/0,::/0则不做限制，为了安全建议按实际情况设置"
              data-bs-toggle="tooltip">?</span>
          </label>
          <div class="col-sm-11">
            <input type="text"
              value=""
              class="form-control" id="security.synology_webhook_allow_ip.ipv4" placeholder="允许的IPv4 CIDR"
              autocomplete="off">
            <input type="text"
              value=""
              class="form-control" id="security.synology_webhook_allow_ip.ipv6" placeholder="允许的IPv6 CIDR"
              autocomplete="off">
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-xl">
          <div class="mb-3">
            <label class="form-check form-switch" style="margin-top: 0.75em;">
              <input class="form-check-input" type="checkbox" id="security.check_apikey">
              <span class="form-check-label">验证外部请求的API密钥
                <span class="form-help"
                  title="启用后，需要在原来的NAStool API地址后面拼接 ?apikey=xxx ，xxx 为API密钥；例如Emby回调接口由原来的 http://nastool:3000/emby 改为 http://nastool:3000/emby?apikey=xxx。受影响的接口有：plex、jellyfin、emby、telegram、synology、slack、ical"
                  data-bs-toggle="tooltip">?</span>
              </span>
            </label>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="card border-0">
    <div class="card-header">
      <h4 class="card-title"><strong>实验室</strong></h4>
      <div class="card-actions btn-actions">
        <a href="javascript:slideToggle('laboratory')" class="btn-action ms-1" title="展开/折叠">
          <i class="ti ti-menu-2 fs-2"></i>
        </a>
      </div>
    </div>
    <div class="card-body border-bottom" id="laboratory" style="display: none;">
      <div class="row">
        <div class="col-12 col-xl-3">
          <div class="mb-3">
            <label class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="laboratory.use_douban_titles">
              <span class="form-check-label">默认搜索豆瓣资源 <span class="form-help"
                  title="开启将使用豆瓣进行电影电视剧的名称搜索，允许中文名不完整时自动联想，但如豆瓣数据与TMDB不一致时可能会无法搜索；关闭后使用TMDB的数据，对中文支持不友好，但不会有无法搜索的问题"
                  data-bs-toggle="tooltip">?</span></span>
            </label>
          </div>
        </div>
        <div class="col-12 col-xl-3">
          <div class="mb-3">
            <label class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="laboratory.search_adult">
              <span class="form-check-label">TMDB搜索成人资源 <span class="form-help"
                  title="TMDB默认不返回成人内容" data-bs-toggle="tooltip">?</span>
              </span>
            </label>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-12 col-xl-3">
          <div class="mb-3">
            <label class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="laboratory.tmdb_cache_expire">
              <span class="form-check-label">TMDB缓存过期策略 <span class="form-help"
                  title="开启TMDB缓存过期策略后，默认7天过期，过期缓存将被删除,  7天内访问过期时间可以被刷新，建议开启" data-bs-toggle="tooltip">?</span>
              </span>
            </label>
          </div>
        </div>
        <div class="col-12 col-xl-3">
          <div class="mb-3">
            <label class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="laboratory.search_keyword">
              <span class="form-check-label">辅助识别 <span class="form-help"
                  title="开启后，无法识别到媒体信息时会尝试猜测和纠正关键词并再次匹配，会大大增加识别耗时，一般情况下不建议开启" data-bs-toggle="tooltip">?</span>
              </span>
            </label>
          </div>
        </div>
        <div class="col-12 col-xl-3">
          <div class="mb-3">
            <label class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="laboratory.search_tmdbweb">
              <span class="form-check-label">WEB增强识别 <span class="form-help"
                  title="开启后，通过TMDB的API无法识别到媒体信息时，会尝试通过themoviedb.org网站再次搜索匹配，仅个别极端情况下有效，会大大增加识别耗时，一般情况下不建议开启"
                  data-bs-toggle="tooltip">?</span>
              </span>
            </label>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="card-footer border-0">
    <div class="row align-items-center">
      <div class="col"></div>
      <div class="col-auto">
        <a id="basic_system_btn" href="javascript:save_basic_config('sys_config')" class="btn btn-primary">
          保存
        </a>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">

  var target_theme = localStorage.getItem("theme") === "dark" ? "ace/theme/one_dark" : "ace/theme/xcode";

  // 重新渲染部分元素
  function render_part(element_id) {

    if (!element_id) {
      return;
    }

    var page = window.history.state?.page.replaceAll(" ", "%20");
    if (!page) {
      return;
    }

    if (!element_id.startsWith("#")) {
      element_id = '#' + element_id;
    }

    $.ajax({
      url: page,
      dataType: 'html',
      success: function (data) {
        // 创建一个临时的 DOM 元素来解析响应 HTML
        var $response = $('<div>').html(data);
        // 修复登录页面刷新问题
        if ($response.find("title").first().text() === "登录 - NAStool") {
          // 刷新页面
          window.location.reload();
          return;
        }
        // 从响应中提取指定 ID 的元素
        var $newContent = $response.find(element_id);
        // 用新内容替换当前页面中的对应元素
        $(element_id).replaceWith($newContent);

        // 展示该面板
        if ($(element_id).hasClass('tab-pane')) {
          $(element_id).addClass('active show');
        } else {
          $(element_id).show();
        }

      }
    });

  }

  // 保存基础设置
  function save_basic_config(type, flag = true) {
    let params = input_select_GetVal(type);
    if (params["media.category"] === "config") {
      show_warning_modal("非法二级分类策略名称");
      return;
    }
    if (flag) {
      $("#" + type + "_btn").text("保存中...").attr("disabled", true);
    }
    axios_post_do("update_config", params, function (ret) {
      if (flag) {
        $("#" + type + "_btn").text("保存").attr("disabled", false);
        // window_history_refresh();
        show_success_modal("配置已保存!");
      }
    });
  }

</script>

<script type="text/javascript">

  // 保存配置、关闭和刷新页面
  function save_mediaserver_config(type) {
    $("#modal-" + type).modal('hide');

    const params = input_select_GetVal(`modal-${type}`);
    params['test'] = false;
    params['media.media_server'] = type;
    axios_post_do("update_config", params, function (ret) {
      window_history_refresh();
    });

  }

  //保存配置和测试配置
  function test_mediaserver_config(type) {

    $("#" + type + "_test_btn").text("测试中...").attr("disabled", true);

    var mediaServerConf = $("#media-server-list").data("server_conf");
    if (mediaServerConf && mediaServerConf[type]) {
      var command = mediaServerConf[type].test_command;
      axios_post_do("test_connection", {"command": command}, function (ret) {
        if (ret.code === 0) {
          $("#" + type + "_test_btn").text("测试成功").attr("disabled", false);
        } else {
          $("#" + type + "_test_btn").text("测试失败！").attr("disabled", false);
        }
      });

      return;
    }

  }


  function genFormConfigElements(type, config, fields) {

    let $container = $("<div>");
    let $row;
    let index = 0;
    $.each(fields, function (fieldId, fieldAttr) {
      if (index % 2 === 0) {
        $row = $("<div class='row'>");
        $container.append($row);
      }

      let colClass = (fieldAttr.type === "switch") ? "col-12" : "col-lg";
      let $col = $('<div class="' + colClass + '"><div class="mb-3"></div></div>');
      let $inner = $col.find(".mb-3");

      if (fieldAttr.type === "switch") {
        let checked = (config[type] && config[type][fieldId]) ? "checked" : "";
        $inner.append(`
          <label class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="${fieldAttr.id}" ${checked}>
            <span class="form-check-label">${fieldAttr.title}</span>
          </label>
        `);
      } else {
        let requiredClass = fieldAttr.required ? "required" : "";
        let value = (config[type] && config[type][fieldId]) ? config[type][fieldId] : "";
        if (fieldAttr.type === "select") {
          let $select = $('<select class="form-select" id="' + fieldAttr.id + '"></select>');
          $.each(fieldAttr.options, function (optValue, optTitle) {
            let selected = (value === optValue) ? "selected" : "";
            $select.append('<option value="' + optValue + '" ' + selected + '>' + optTitle + '</option>');
          });
          $inner.append(`<label class="form-label ${requiredClass}">${fieldAttr.title}</label>`).append($select);
        } else {
          $inner.append(`
            <label class="form-label ${requiredClass}">${fieldAttr.title}</label>
            <input type="${fieldAttr.type}" id="${fieldAttr.id}" class="form-control" value="${value}" placeholder="${fieldAttr.placeholder || ""}">
          `);
        }
      }

      $row.append($col);

      index++;
    });
    return $container.html();
  }

  // 渲染媒体服务器卡片 & 模态框
  function renderMediaServers(mediaServerConf, configInfo) {

    let $list = $("#media-server-list");
    $list.data("server_conf", mediaServerConf);

    $.each(mediaServerConf, function (type, server) {
      let active = (configInfo.media.media_server === type) ?
        `<div class="col-auto align-self-center"><span class="badge bg-green"></span> 正在使用</div>` : "";

      $list.append(`
        <a class="card card-link-pop p-0 rounded-3 overflow-hidden" href="#" data-bs-toggle="modal" data-bs-target="#modal-${type}">
          <div class="card card-sm card-link-pop ${server.background}">
            <div class="card-body">
              <div class="row align-items-center">
                <div class="col-auto"><span class="text-white avatar" style="background-image: url(${server.img_url})"></span></div>
                <div class="col"><div class="font-weight-medium">${server.name}</div></div>
                ${active}
              </div>
            </div>
          </div>
        </a>
      `);

      $("#page-content").append(`
        <div class="modal modal-blur fade" id="modal-${type}" tabindex="-1">
          <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">${server.name}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                ${genFormConfigElements(type, configInfo, server.config)}
              </div>
              <div class="modal-footer">
                <a href="javascript:test_mediaserver_config('${type}')" id="${type}_test_btn" class="btn me-auto">测试</a>
                <a href="javascript:save_mediaserver_config('${type}')" id="${type}_save_btn" class="btn btn-primary">确定</a>
              </div>
            </div>
          </div>
        </div>
      `);
    });
  }

</script>

<script type="text/javascript">

  // 页面加载完成后，使用axios_post请求/data/basic接口获取数据并填充页面
  $(document).ready(function() {

    axios_post('/data/basic', {}, function(response) {
      
      if (response.code === 0 && response.data) {

        const data = response.data;

        // 填充基础设置数据
        if (data.Config && data.Config.app) {
          $('#app\\.web_port').val(data.Config.app.web_port || '');
          $('#app\\.login_user').val(data.Config.app.login_user || '');
          $('#app\\.login_password').val(data.Config.app.login_password || '');
          $('#app\\.wallpaper').val(data.Config.app.wallpaper || 'themoviedb');
          $('#app\\.loglevel').val(data.Config.app.loglevel || 'info');
          $('#app\\.logtype').val(data.Config.app.logtype || 'console');
          $('#app\\.logpath').val(data.Config.app.logpath || '');
          $('#app\\.logserver').val(data.Config.app.logserver || '');
          $('#app\\.rmt_tmdbkey').val(data.Config.app.rmt_tmdbkey || '');
          if (!data.Config.app.rmt_tmdbkey) {
            $('#app\\.rmt_tmdbkey').addClass('is-invalid');
          }
          $('#app\\.tmdb_domain').val(data.Config.app.tmdb_domain || '');
          $('#app\\.rmt_match_mode').val(data.Config.app.rmt_match_mode || 'normal');
          $('#app\\.tmdb_image_url').val(data.Config.app.tmdb_image_url || '');
          $('#app\\.domain').val(data.Config.app.domain || '');
          $('#app\\.user_agent').val(data.Config.app.user_agent || '');
          $('#app\\.ocr_url').val(data.Config.app.ocr_url || '');
          $('#app\\.ssl_cert').val(data.Config.app.ssl_cert || '');
          $('#app\\.ssl_key').val(data.Config.app.ssl_key || '');
          $('#app\\.releases_update_only').prop('checked', data.Config.app.releases_update_only || false);
        }

        // 填充代理设置
        if (data.Proxy) {
          $('#app\\.proxies').val(data.Proxy);
        }

        // 填充TMDB域名选项
        if (data.TmdbDomains) {
          const tmdbDomainSelect = $('#app\\.tmdb_domain');
          tmdbDomainSelect.empty();
          data.TmdbDomains.forEach(function(domain) {
            const selected = data.Config && data.Config.app && data.Config.app.tmdb_domain === domain ? 'selected' : '';
            tmdbDomainSelect.append(`<option value="${domain}" ${selected}>${domain}</option>`);
          });
        }

        // 填充媒体设置数据
        if (data.Config && data.Config.media) {
          $('#media\\.mediasync_interval').val(data.Config.media.mediasync_interval || '');
        }

        // 填充服务配置数据
        if (data.Config && data.Config.pt) {
          $('#pt\\.download_order').val(data.Config.pt.download_order || '');
          $('#pt\\.pt_check_interval').val(data.Config.pt.pt_check_interval || '');
          $('#pt\\.search_rss_interval').val(data.Config.pt.search_rss_interval || '');
          $('#pt\\.ptrefresh_date_cron').val(data.Config.pt.ptrefresh_date_cron || '');
          $('#pt\\.search_auto').prop('checked', data.Config.pt.search_auto || false);
          $('#pt\\.search_no_result_rss').prop('checked', data.Config.pt.search_no_result_rss || false);
        }

        // 填充安全配置数据
        if (data.Config && data.Config.security) {
          $('#security\\.api_key').val(data.Config.security.api_key || '');
          $('#security\\.check_apikey').prop('checked', data.Config.security.check_apikey || false);
          if (data.Config.security.media_server_webhook_allow_ip) {
            $('#security\\.media_server_webhook_allow_ip\\.ipv4').val(data.Config.security.media_server_webhook_allow_ip.ipv4 || '');
            $('#security\\.media_server_webhook_allow_ip\\.ipv6').val(data.Config.security.media_server_webhook_allow_ip.ipv6 || '');
          }
          if (data.Config.security.telegram_webhook_allow_ip) {
            $('#security\\.telegram_webhook_allow_ip\\.ipv4').val(data.Config.security.telegram_webhook_allow_ip.ipv4 || '');
            $('#security\\.telegram_webhook_allow_ip\\.ipv6').val(data.Config.security.telegram_webhook_allow_ip.ipv6 || '');
          }
          if (data.Config.security.synology_webhook_allow_ip) {
            $('#security\\.synology_webhook_allow_ip\\.ipv4').val(data.Config.security.synology_webhook_allow_ip.ipv4 || '');
            $('#security\\.synology_webhook_allow_ip\\.ipv6').val(data.Config.security.synology_webhook_allow_ip.ipv6 || '');
          }
        }

        // 填充实验室配置数据
        if (data.Config && data.Config.openai) {
          $('#openai\\.api_key').val(data.Config.openai.api_key || '');
          $('#openai\\.api_url').val(data.Config.openai.api_url || '');
        }

        if (data.Config && data.Config.laboratory) {
          $('#laboratory\\.chatgpt_enable').prop('checked', data.Config.laboratory.chatgpt_enable || false);
          $('#laboratory\\.search_keyword').prop('checked', data.Config.laboratory.search_keyword || false);
          $('#laboratory\\.search_tmdbweb').prop('checked', data.Config.laboratory.search_tmdbweb || false);
          $('#laboratory\\.use_douban_titles').prop('checked', data.Config.laboratory.use_douban_titles || false);
          $('#laboratory\\.search_adult').prop('checked', data.Config.laboratory.search_adult || false);
          $('#laboratory\\.tmdb_cache_expire').prop('checked', data.Config.laboratory.tmdb_cache_expire || false);
        }

        // 填充刮削设置数据
        if (data.ScraperNfo) {
          if (data.ScraperNfo.movie) {
            $('#scraper_nfo_movie_basic').prop('checked', data.ScraperNfo.movie.basic || false);
            $('#scraper_nfo_movie_credits').prop('checked', data.ScraperNfo.movie.credits || false);
            $('#scraper_nfo_movie_credits_chinese').prop('checked', data.ScraperNfo.movie.credits_chinese || false);
          }
          if (data.ScraperNfo.tv) {
            $('#scraper_nfo_tv_basic').prop('checked', data.ScraperNfo.tv.basic || false);
            $('#scraper_nfo_tv_credits').prop('checked', data.ScraperNfo.tv.credits || false);
            $('#scraper_nfo_tv_credits_chinese').prop('checked', data.ScraperNfo.tv.credits_chinese || false);
            $('#scraper_nfo_tv_season_basic').prop('checked', data.ScraperNfo.tv.season_basic || false);
            $('#scraper_nfo_tv_episode_basic').prop('checked', data.ScraperNfo.tv.episode_basic || false);
            $('#scraper_nfo_tv_episode_credits').prop('checked', data.ScraperNfo.tv.episode_credits || false);
          }
        }

        if (data.ScraperPic) {
          if (data.ScraperPic.movie) {
            $('#scraper_pic_movie_poster').prop('checked', data.ScraperPic.movie.poster || false);
            $('#scraper_pic_movie_backdrop').prop('checked', data.ScraperPic.movie.backdrop || false);
            $('#scraper_pic_movie_background').prop('checked', data.ScraperPic.movie.background || false);
            $('#scraper_pic_movie_logo').prop('checked', data.ScraperPic.movie.logo || false);
            $('#scraper_pic_movie_disc').prop('checked', data.ScraperPic.movie.disc || false);
            $('#scraper_pic_movie_banner').prop('checked', data.ScraperPic.movie.banner || false);
            $('#scraper_pic_movie_thumb').prop('checked', data.ScraperPic.movie.thumb || false);
          }
          if (data.ScraperPic.tv) {
            $('#scraper_pic_tv_poster').prop('checked', data.ScraperPic.tv.poster || false);
            $('#scraper_pic_tv_backdrop').prop('checked', data.ScraperPic.tv.backdrop || false);
            $('#scraper_pic_tv_background').prop('checked', data.ScraperPic.tv.background || false);
            $('#scraper_pic_tv_logo').prop('checked', data.ScraperPic.tv.logo || false);
            $('#scraper_pic_tv_clearart').prop('checked', data.ScraperPic.tv.clearart || false);
            $('#scraper_pic_tv_banner').prop('checked', data.ScraperPic.tv.banner || false);
            $('#scraper_pic_tv_thumb').prop('checked', data.ScraperPic.tv.thumb || false);
            $('#scraper_pic_tv_season_poster').prop('checked', data.ScraperPic.tv.season_poster || false);
            $('#scraper_pic_tv_season_banner').prop('checked', data.ScraperPic.tv.season_banner || false);
            $('#scraper_pic_tv_season_thumb').prop('checked', data.ScraperPic.tv.season_thumb || false);
            $('#scraper_pic_tv_episode_thumb').prop('checked', data.ScraperPic.tv.episode_thumb || false);
            $('#scraper_pic_tv_episode_thumb_ffmpeg').prop('checked', data.ScraperPic.tv.episode_thumb_ffmpeg || false);
          }
        }
      
        // 渲染媒体服务器
        if (data.MediaServerConf) {
          renderMediaServers(data.MediaServerConf, data.Config);
        }
      
      }

    });
  });

</script>