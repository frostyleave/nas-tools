<div class="input-group top-sub-navbar mx-2" >
  <input type="hidden" id="downloaderId" value="">
  <ul class="nav nav-tabs card-header-tabs" data-bs-toggle="tabs" role="tablist" id="downloader-tabs">
  </ul>
</div>
<div class="container-xl">
  <!-- Page title -->
  <div class="page-header d-print-none">
    <div class="row align-items-center">
      <div class="col">
      </div>
      <div class="col-auto ms-auto d-print-none">
        <div class="btn-list">
          <button data-bs-toggle="dropdown" type="button" class="btn btn-primary d-none d-sm-inline-flex dropdown-toggle">
            <i class="ti ti-plus fs-2"></i>
            新增下载
          </button>
          <button data-bs-toggle="dropdown" type="button" class="btn btn-primary d-sm-none btn-icon">
            <i class="ti ti-plus fs-2"></i>
          </button>
          <div class="dropdown-menu dropdown-menu-end">
            <button class="dropdown-item" onclick="show_torrent_download_modal('torrent')">
              种子文件
            </button>
            <button class="dropdown-item" onclick="show_torrent_download_modal('url')">
              种子链接
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="page-body" id="downloading-container" style="display: none;">
  <div class="container-xl">
    <div class="d-grid gap-3 grid-info-card" id="downloading-list">
    </div>
  </div>
</div>
<nodata-found id="no-downloads" title="没有下载任务" text="当前下载器中没有正在下载的任务。" style="display: none;"></nodata-found>
<script type="text/javascript">

  // 下载控制
  function start_pt_download(id) {
    axios_post_do("pt_start", { "id": id }, function (ret) {
      get_torrent_info(ret.id)
    });
  }

  function stop_pt_download(id) {
    axios_post_do("pt_stop", { "id": id }, function (ret) {
      get_torrent_info(ret.id)
    });
  }

  function remove_pt_download(id, download_name) {

    show_ask_modal("是否确定删除： " + download_name + " 下载任务?", function () {
      // 隐藏询问框
      hide_ask_modal();
      // 执行删除
      axios_post_do("pt_remove", { "id": id }, function (ret) {
        window_history_refresh();
      });
    }, '');

  }

  // 获取下载器正在下载的种子
  function get_downloader_torrents(downloaderId) {

    // 设置当前下载器ID
    $('#downloaderId').val(downloaderId);

    axios_post_do("get_downloading", {downloader_id: downloaderId}, function (ret) {

      if (ret.code === 0) {

        // 生成下载任务列表
        if (ret.result && ret.result.length > 0) {

          const downloadingList = $('#downloading-list');
          downloadingList.empty();

          ret.result.forEach(torrent => {

            const startBtnStyle = torrent.state === 'Downloading' ? 'display:none' : '';
            const stopBtnStyle = torrent.state === 'Stoped' ? 'display:none' : '';

            const torrentCard = `
              <div class="card p-0">
                <div class="card-body media-box" style="background-image: url(${torrent.backdrop || ''});">
                  <div class="right-top-box">
                    <a href="javascript:remove_pt_download('${torrent.id}', '${torrent.title || torrent.name}')" class="text-danger"><i class="ti ti-x fs-2"></i></a>
                  </div>
                  <div class="row align-items-stretch media-content card-text">
                    ${torrent.image ? `
                      <div class="col-auto p-0 card cover-container">
                        <img src="${torrent.image}" class="rounded" alt="" style="max-width: 80px;">
                      </div>
                    ` : ''}
                    <div class="col">
                      <h3 class="card-title mb-1">
                        ${torrent.tmdbid && torrent.type ?
                          `<a href='javascript:navmenu("media_detail?type=${torrent.type}&id=${torrent.tmdbid}")' class="text-reset card-text">${torrent.title || torrent.name}</a>` :
                          `<span class="text-reset card-text">${torrent.title || torrent.name}</span>`
                        }
                      </h3>
                      <div>
                        ${torrent.vote ? `<span class="badge badge-pill bg-purple text-white">${torrent.vote}</span>` : ''}
                        ${torrent.se ? `<span class="badge badge-pill bg-gray text-white">${torrent.se}</span>` : ''}
                      </div>
                      <div class="download-speed-indicator">
                        ${torrent.site ? `<span class="badge badge-outline text-teal" title="站点">${torrent.site}</span>` : ''}
                        <i class="ti ti-arrow-down"></i><span class="txt-download-speed" id="dlspeed_txt_${torrent.id}">${torrent.dlspeed || '0B/s'}</span>
                        <i class="ti ti-arrow-up"></i><span class="txt-upload-speed" id="upspeed_txt_${torrent.id}">${torrent.upspeed || '0B/s'}</span>
                      </div>
                      <div class="space-between-box">
                        <div class="col-auto" id="progress_text_${torrent.id}">
                          ${torrent.sizeprogress || '0B / 0B'}
                        </div>
                        <div class="col-auto">
                          <a href="javascript:start_pt_download('${torrent.id}')" id="start_btn_${torrent.id}" style="${startBtnStyle}"><i class="ti ti-player-play fs-2"></i></a>
                          <a href="javascript:stop_pt_download('${torrent.id}')" id="stop_btn_${torrent.id}" style="${stopBtnStyle}"><i class="ti ti-player-pause fs-2"></i></a>
                        </div>
                      </div>
                      <div class="progress progress-sm progress-bottom">
                        <div class="progress-bar" id="progress_${torrent.id}" style="width: ${torrent.progress || 0}%" role="progressbar" aria-valuenow="${torrent.progress || 0}" aria-valuemin="0" aria-valuemax="100">
                          <span class="visually-hidden"></span>
                        </div>
                      </div>
                    </div>
                    <input type="hidden" class="download_ids" id="id_${torrent.id}" value="${torrent.id}">
                  </div>
                </div>
              </div>
            `;
            downloadingList.append(torrentCard);
          });

          $('#downloading-container').show();
          $('#no-downloads').hide();

          // 事件
          setTimeout("get_all_torrents_info()", 2000);

        } else {
          $('#downloading-container').hide();
          $('#no-downloads').show();
        }
      }      
    });

  }

  // 更新所有种子页面信息
  function get_all_torrents_info() {
    var ids = [];
    $(".download_ids").each(function () {
      ids.push($(this).val());
    });
    if (ids.length == 0) {
      return;
    }
    var downloaderId = $('#downloaderId').val();
    axios_post_do("pt_info", { "downloaderId": downloaderId, "ids": ids }, function (ret) {
      if (ret.retcode == "0") {
        for (var torrent of ret.torrents) {
          // 种子下载完成, 刷新界面
          if (info.progress >= 100) {
            get_downloader_torrents(downloaderId);
            break;
          }
          update_torrent_ui(torrent);
        }
        setTimeout("get_all_torrents_info()", 2000);
      }
    }, true, false);
  }

  //更新一个种子页面信息
  function get_torrent_info(id) {
    axios_post_do("pt_info", { "ids": id }, function (ret) {
      if (ret.retcode == "0") {
        for (let torrent of ret.torrents) {
          update_torrent_ui(torrent);
        }
      }
    }, true, false);
  }

  // 更新单个种子的页面信息
  function update_torrent_ui(info) {

    $(`#dlspeed_txt_${info.id}`).text(info.dlspeed);
    $(`#upspeed_txt_${info.id}`).text(info.upspeed);
    $(`#progress_text_${info.id}`).text(`${info.sizeprogress}`);
    $(`#progress_${info.id}`).attr("style", `width: ${info.progress}%`)
      .attr("aria-valuenow", info.progress);
    if (info.state === "Stoped") {
      $(`#start_btn_${info.id}`).show()
      $(`#stop_btn_${info.id}`).hide()
    } else {
      $(`#start_btn_${info.id}`).hide()
      $(`#stop_btn_${info.id}`).show()
    }
  }

  //显示新增下载界面
  function show_torrent_download_modal(type) {
    show_download_modal('', '', '', function () {
      let urls = $("#torrent_urls").val();
      if ((!TorrentDropZone || !TorrentDropZone.files || !TorrentDropZone.files[0]) && !urls) {
        return;
      }
      $("#search_download_btn").text("处理中...").attr("disabled", true);
      const params = {
        "files": TorrentDropZone.files,
        "urls": urls.split("\n"),
        "dl_dir": get_savepath("search_download_dir", "search_download_dir_manual"),
        "dl_setting": $("#search_download_setting").val()
      }
      axios_post_do("download_torrent", params, function (ret) {
        $("#search_download_btn").attr("disabled", false).text("下载");
        $("#modal-search-download").modal('hide');
        if (ret.code == 0) {
          TorrentDropZone.removeAllFiles();
          $("#torrent_urls").val("");
          window_history_refresh();
        } else {
          show_fail_modal(`添加下载失败：${ret.msg}`, function () {
            $("#modal-search-download").modal('show');
          });
        }
      });
    }, type);
  }

</script>

<script>

  $(document).ready(function () {

    // 获取活跃下载器配置
    axios_post('/data/downloading', {}, function(response) {

      if (response.code === 0 && response.data) {

        const data = response.data;

        // 生成下载器导航标签
        if (data.Downloaders && data.Downloaders.length > 0) {

          const downloaderTabs = $('#downloader-tabs');
          downloaderTabs.empty();

          data.Downloaders.forEach(downloader => {
            const tabItem = `
              <li class="nav-item">
                <a class="nav-link " href="void(0)" data-bs-toggle="tab" data-id="${downloader.id}" onclick="get_downloader_torrents('${downloader.id}')">
                  <span class="d-md-none" style="color:var(--tblr-body-color);">${downloader.name}</span>
                  <span class="d-none d-md-inline">${downloader.name}</span>
                </a>
              </li>
            `;
            downloaderTabs.append(tabItem);
          });

          // 模拟点击第一个
          $("#downloader-tabs a.nav-link").first().trigger("click");
          $("#downloader-tabs a.nav-link").first().addClass("active")

        }

      }
    }, true, true);
  });
</script>