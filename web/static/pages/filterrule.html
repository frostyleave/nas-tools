<div class="container-xl">
  <!-- Page title -->
  <div class="page-header d-print-none">
    <div class="row align-items-center">
      <div class="col">
      </div>
      <div class="col-auto ms-auto d-print-none">
        <div class="btn-list">
          <a href="javascript:show_add_filtergroup_modal()" class="btn btn-primary d-none d-sm-inline-flex">
            <i class="ti ti-plus fs-2 me-1"></i>
            新增
          </a>
          <a href="javascript:show_add_filtergroup_modal()" class="btn btn-primary d-sm-none btn-icon">
            <i class="ti ti-plus fs-2 me-1"></i>
          </a>
          <a href="javascript:show_restore_filtergroup_modal()" class="btn btn-twitter d-none d-sm-inline-flex">
            <i class="ti ti-reload fs-2 me-1"></i>
            恢复
          </a>
          <a href="javascript:show_restore_filtergroup_modal()" class="btn btn-twitter d-sm-none btn-icon">
            <i class="ti ti-reload fs-2 me-1"></i>
          </a>
          <a href="javascript:show_import_filtergroup_modal()" class="btn d-none d-sm-inline-flex">
            <i class="ti ti-transfer-in fs-2 me-1"></i>
            导入
          </a>
          <a href="javascript:show_import_filtergroup_modal()" class="btn d-sm-none btn-icon">
            <i class="ti ti-transfer-in fs-2 me-1"></i>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- 业务页面代码 -->
<div class="page-body">
  <div class="container-xl">
    <div class="d-grid gap-3 grid-info-card align-items-start" id="filterrule-container">
      <!-- 动态生成的内容将在这里显示 -->
    </div>
  </div>
</div>

<script type="text/javascript">
  $(document).ready(function() {
    // 请求数据并生成页面
    axios_post("/data/filterrule", {}, function(ret) {
      if (ret.code === 0) {
        generateFilterRulePage(ret.data);
      } else {
        show_fail_modal("加载过滤规则失败");
      }
    });
  });

  // 生成过滤规则页面内容
  function generateFilterRulePage(data) {
    const container = $("#filterrule-container");
    container.empty();

    // 存储初始规则组数据，避免污染window对象
    container.data('initRuleGroups', data.Init_RuleGroups);

    if (!data.RuleGroups || data.RuleGroups.length === 0) {
      container.parent().parent().html('<empty-content title="没有规则" text=\'没有配置任何规则，请点击"新增规则组"按钮。\'></empty-content>');
      return;
    }

    data.RuleGroups.forEach(function(ruleGroup) {
      const groupHtml = generateRuleGroupHtml(ruleGroup);
      container.append(groupHtml);
    });
  }

  // 生成单个规则组HTML
  function generateRuleGroupHtml(ruleGroup) {
    const defaultIcon = ruleGroup.default === 'Y' ?
      '<i class="ti ti-star-filled fs-2 text-purple"></i>' :
      '<i class="ti ti-star fs-2 me-1"></i>';

    const rulesHtml = generateRulesHtml(ruleGroup);

    return `
      <div class="card align-self-start">
        <div class="card-header">
          <h3 class="card-title"><strong>${ruleGroup.name}</strong></h3>
          <div class="card-actions btn-actions">
            <a href="javascript:void(0)" onclick="show_filterrule_detail('${ruleGroup.id}')" class="btn-action ms-1" title="折叠">
              <i class="ti ti-menu-2 fs-2 me-1"></i>
            </a>
            <a href="javascript:share_filtergroup('${ruleGroup.id}')" class="btn-action" title="分享规则组">
              <i class="ti ti-share fs-2 me-1"></i>
            </a>
            <a href="javascript:set_default_filtergroup('${ruleGroup.id}')" class="btn-action"
               title="设置/取消默认">
              ${defaultIcon}
            </a>
            <a href="javascript:show_add_filterrule_modal('${ruleGroup.id}', '${ruleGroup.name}')"
               class="btn-action" title="增加规则">
              <i class="ti ti-plus fs-2 me-1"></i>
            </a>
            <a href="javascript:del_filtergroup_modal('${ruleGroup.id}', '${ruleGroup.name}')"
               class="btn-action" title="删除规则组">
              <i class="ti ti-x fs-2 me-1"></i>
            </a>
          </div>
        </div>
        <div class="card-body p-2" id="div_group${ruleGroup.id}">
          <div class="row row-cards">
            ${rulesHtml}
          </div>
        </div>
      </div>
    `;
  }

  // 生成规则HTML
  function generateRulesHtml(ruleGroup) {
    if (!ruleGroup.rules || ruleGroup.rules.length === 0) {
      return '<empty-content title="没有规则" text=\'请点击"+"添加规则。\'></empty-content>';
    }

    return ruleGroup.rules.map(rule => {
      const freeText = rule.free_text ?
        `<span class="badge bg-info me-1 mb-1 text-wrap text-start" title="促销" style='word-break: break-all'>${rule.free_text}</span>` : '';

      const includeRules = rule.include.map(include =>
        `<span class="badge badge-outline text-info me-1 mb-1 text-wrap text-start" title="包含规则" style='word-break: break-all'>包含: ${include}</span>`
      ).join('');

      const excludeRules = rule.exclude.map(exclude =>
        `<span class="badge badge-outline text-red me-1 mb-1 text-wrap text-start" title="排除规则" style='word-break: break-all'>排除: ${exclude}</span>`
      ).join('');

      const sizeRule = rule.size ?
        `<span class="badge badge-outline text-orange me-1 mb-1 text-wrap text-start" title="大小限制" style='word-break: break-all'>大小: ${rule.size}</span>` : '';

      return `
        <div class="col-12">
          <a class="card card-link card-link-pop card-borderless"
             href="javascript:show_modify_filterrule_modal('${ruleGroup.id}', '${rule.id}', '${ruleGroup.name}')"
             title="编辑规则">
            <div class="card-body p-2">
              <span class="badge bg-purple badge-pill position-absolute" style="top: 10px; left:10px">${rule.pri}</span>
              <h3 class="card-title ps-4">${rule.name}</h3>
              <div class="w-100">
                ${freeText}
                ${includeRules}
                ${excludeRules}
                ${sizeRule}
              </div>
            </div>
          </a>
        </div>
      `;
    }).join('');
  }
</script>