<div class="page-body">
  <div class="container-xl">
    <div class="col-12 mb-1">
      <div class="card">
        <div class="card-header">
          <h4 class="card-title"><strong>存储设置</strong></h4>
          <div class="card-actions btn-actions">
            <a href="javascript:void(0)" class="btn d-none d-sm-inline-block" data-bs-toggle="modal"data-bs-target="#modal-scraper">
              刮削设置
            </a>
            <a href="javascript:void(0)" class="btn d-sm-none mbtn-action" data-bs-toggle="modal"data-bs-target="#modal-scraper" title="刮削设置">
              <i class="ti ti-slideshow fs-2"></i>
            </a>
            <a href="javascript:slideToggle('sys_media_config')" class="btn-action ms-1" title="展开/折叠">
              <i class="ti ti-menu-2 fs-2"></i>
            </a>
          </div>
        </div>
        <div class="card-body" id="sys_media_config">
          <div class="row">
            <div class="col-lg">
              <div class="mb-3">
                <label class="form-label">文件管理默认路径 <span class="form-help" title="文件管理、自定义识别等默认路径" data-bs-toggle="tooltip">?</span></label>
                <input type="text" value="" class="form-control filetree-folders-only" id="media.media_default_path" placeholder="/" autocomplete="off">
              </div>
            </div>
            <div class="col-lg">
              <div class="mb-3">
                <label class="form-label">文件二级分类策略 <span class="form-help"
                    title="启用二级分类后会在电影/电视剧/动漫媒体库目录下按二级分类名建立子目录；此处配置分类的策略名，保存后会自动生成默认配置；如不需要启动分类，则该项配置为空"
                    data-bs-toggle="tooltip">?</span></label>
                <div class="input-group input-group-flat">
                  <input type="text" value="" class="form-control" id="media.category"
                    placeholder="留空不启用二级分类" autocomplete="off" name="category_name">
                  <span class="input-group-text">
                    <a href="javascript:show_category_config_modal()" class="link-secondary" title="编辑二级分类策略"
                      data-bs-toggle="tooltip">
                      <i class="ti ti-edit fs-2"></i>
                    </a>
                  </span>
                </div>
              </div>
            </div>
            <div class="col-lg">
              <div class="mb-3">
                <label class="form-label required">默认文件转移方式 <span class="form-help" title="手动识别等未指定转移方式的场景默认使用的转移方式"
                    data-bs-toggle="tooltip">?</span></label>
                <select id="media.default_rmt_mode" class="form-select">
                </select>
              </div>
            </div>
            <div class="col-lg">
              <div class="mb-3">
                <label class="form-label required">转移最小文件大小(MB) <span class="form-help" title="小于该大小的文件将会忽略，不进行转移重命名"
                    data-bs-toggle="tooltip">?</span></label>
                <input type="text" value="" class="form-control"
                  id="media.min_filesize" placeholder="200" autocomplete="off">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg">
              <div class="mb-3">
                <label class="form-label">文件路径转移忽略词 <span class="form-help" title="文件路径包含忽略词的，忽略转移，支持正则表达式，注意特殊字符转义"
                    data-bs-toggle="tooltip">?</span></label>
                <input type="text" value="" class="form-control"
                  id="media.ignored_paths" placeholder="支持正则表达式，使用;分隔" autocomplete="off">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg">
              <div class="mb-3">
                <label class="form-label">文件名转移忽略词 <span class="form-help" title="文件名（包括扩展名）包含忽略词的，忽略转移，支持正则表达式，注意特殊字符转义"
                    data-bs-toggle="tooltip">?</span></label>
                <input type="text" value="" class="form-control"
                  id="media.ignored_files" placeholder="支持正则表达式，使用;分隔" autocomplete="off">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg">
              <div class="mb-3">
                <label class="form-label required">电影重命名格式 <span class="form-help"
                    title="程序会按定义的命名格式对电影进行重命名；/代表上下级目录，{}内为占位符，转义为&#123;&#123;&#125;&#125;；占位符会使用文件识别出来的实际值替换；占位符外的字符会当成普通字符，直接体现在名称上。<br>电影占位符：<br>{title}：标题<br>{en_title}：英文标题<br>{original_title}：原语种标题<br>{original_name}：原文件名<br>{rev_name}：识别词处理后的原文件名<br>{year}：年份<br>{edition}：版本(Bluray/WEB-DL等)<br>{videoFormat}：分辨率(1080p/4k等)<br>{videoCodec}：视频编码<br>{audioCodec}：音频编码及声道<br>{tmdbid}：TMDB的ID<br>{imdbid}：IMDB的ID<br>{part}：part1/disc1/dvd1<br>{releaseGroup}：制作组/字幕组<br>{name}：识别名称（文件名中识别出的名称，可用自定义识别词替换）<br><br>重命名使用Python的format格式化，可进行指定格式输出"
                    data-bs-toggle="tooltip" data-bs-html="true">?</span></label>
                <input type="text" value="" class="form-control"
                  id="media.movie_name_format" placeholder="{title} ({year})/{title}-{part} ({year}) - {videoFormat}"
                  autocomplete="off">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg">
              <div class="mb-3">
                <label class="form-label required">剧集重命名格式 <span class="form-help"
                    title="程序会按定义的命名格式对电视剧进行重命名；/代表上下级目录，{}内为占位符，转义为&#123;&#123;&#125;&#125;；占位符会使用文件识别出来的实际值替换，占位符外的字符会当成普通字符，直接体现在名称上。<br>电视剧占位符：<br>{title}：标题<br>{en_title}：英文标题<br>{original_title}：原语种标题<br>{original_name}：原文件名<br>{rev_name}：识别词处理后的原文件名<br>{year}：年份<br>{edition}：版本(Bluray/WEB-DL等)<br>{videoFormat}：分辨率(1080p/4k等)<br>{videoCodec}：视频编码<br>{audioCodec}：音频编码及声道<br>{tmdbid}：TMDB的ID<br>{imdbid}：IMDB的ID<br>{season}：季数<br>{episode}：集数<br>{episode_title}：集标题<br>{season_episode}：剧集SxxExx<br>{part}：part1/disc1/dvd1<br>{releaseGroup}：制作组/字幕组<br>{name}：识别名称（文件名中识别出的名称，可用自定义识别词替换）<br><br>重命名使用Python的format格式化，可进行指定格式输出"
                    data-bs-toggle="tooltip" data-bs-html="true">?</span></label>
                <input type="text" value="" class="form-control"
                  id="media.tv_name_format"
                  placeholder="{title} ({year})/Season {season}/{title}-{part} - {season_episode} - 第 {episode} 集"
                  autocomplete="off">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-12 col-xl-3">
              <div class="mb-3">
                <label class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="media.filesize_cover">
                  <span class="form-check-label">高质量文件覆盖 <span class="form-help"
                      title="开启后，如下载了更高质量的同名文件时，会覆盖媒体库中已有的文件，否则不会进行转移处理" data-bs-toggle="tooltip">?</span></span>
                </label>
              </div>
            </div>
            <div class="col-12 col-xl-3">
              <div class="mb-3">
                <label class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="media.nfo_poster">
                  <span class="form-check-label">刮削元数据及图片 <span class="form-help"
                      title="开启后会自动生成nfo描述文件及图片，协助媒体服务器识别和刮削，在刮削设置中自定义刮削内容" data-bs-toggle="tooltip">?</span></span>
                </label>
              </div>
            </div>
          </div>
          <hr class="mt-1 mb-3">
          <div class="row align-items-center">
            <div class="col"></div>
            <div class="col-auto">
              <a id="basic_system_btn" href="javascript:save_basic_config('sys_media_config')" class="btn btn-primary">
                保存
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="d-grid gap-2 grid-large-card align-items-start" id="library-list">
      <!-- JS 动态填充 -->
    </div>
  </div>
</div>

<div class="modal modal-blur fade" id="modal-dirctory" tabindex="-1" role="dialog" aria-hidden="true"
  data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">新增目录</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-lg-12">
            <div class="mb-3">
              <label class="form-label">路径 <span class="form-help"
                  title="Emby/Jellyfin/Plex媒体库对应文件的路径，下载文件转移、目录同步未配置目的目录时，媒体文件将重命名转移到该目录"
                  data-bs-toggle="tooltip">?</span></label>
              <input type="text" value="" id="path_str" class="form-control filetree-folders-only" autocomplete="off">
              <input type="hidden" value="" id="path_type" class="form-control">
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-link me-auto" data-bs-dismiss="modal">取消</button>
        <a href="javascript:add_directory_config()" id="directory_save_btn" class="btn btn-primary">确定</a>
      </div>
    </div>
  </div>
</div>

<div class="modal modal-blur fade" id="modal-scraper" tabindex="-1" role="dialog" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="card modal-content"
      style="border-top-left-radius:var(--tblr-modal-inner-border-radius) !important; border-top-right-radius:var(--tblr-modal-inner-border-radius) !important">
      <div class="card-header"
        style="border-top-left-radius:var(--tblr-modal-inner-border-radius) !important; border-top-right-radius:var(--tblr-modal-inner-border-radius) !important">
        <ul class="nav nav-fill card-header-tabs nav-tabs rounded-3" data-bs-toggle="tabs" role="tablist">
          <li class="nav-item" role="presentation">
            <a href="#tabs-scraper-nfo" class="nav-link active" style="justify-content: center" data-bs-toggle="tab"
              aria-selected="true" role="tab">
              <span class="me-2"><i class="ti ti-info-square-rounded fs-2"></i></span>
              元数据
            </a>
          </li>
          <li class="nav-item" role="presentation">
            <a href="#tabs-scraper-pic" class="nav-link" style="justify-content: center" data-bs-toggle="tab"
              aria-selected="false" role="tab" tabindex="-1">
              <span class="me-2"><i class="ti ti-photo fs-2"></i></span>
              图片
            </a>
          </li>
        </ul>
      </div>
      <div class="card-body">
        <div class="tab-content">
          <div class="tab-pane fade active show" id="tabs-scraper-nfo" role="tabpanel">
            <div class="card-body">
              <div class="row">
                <div class="col">
                  <div class="mb-3">
                    <label class="form-label">电影 </label>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-12 col-lg-4">
                  <div class="mb-3">
                    <label class="form-check">
                      <input class="form-check-input" type="checkbox" id="scraper_nfo_movie_basic">
                      <span class="form-check-label">基础信息 </span>
                    </label>
                  </div>
                </div>
                <div class="col-12 col-lg-4">
                  <div class="mb-3">
                    <label class="form-check">
                      <input class="form-check-input" type="checkbox" id="scraper_nfo_movie_credits">
                      <span class="form-check-label">演职人员 </span>
                    </label>
                  </div>
                </div>
                <div class="col-12 col-lg-4">
                  <div class="mb-3">
                    <label class="form-check">
                      <input class="form-check-input" type="checkbox" id="scraper_nfo_movie_credits_chinese">
                      <span class="form-check-label">演职人员中文 </span>
                    </label>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col">
                  <div class="mb-3">
                    <label class="form-label">电视剧 </label>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-12 col-lg-4">
                  <div class="mb-3">
                    <label class="form-check">
                      <input class="form-check-input" type="checkbox" id="scraper_nfo_tv_basic">
                      <span class="form-check-label">基础信息 </span>
                    </label>
                  </div>
                </div>
                <div class="col-12 col-lg-4">
                  <div class="mb-3">
                    <label class="form-check">
                      <input class="form-check-input" type="checkbox" id="scraper_nfo_tv_credits">
                      <span class="form-check-label">演职人员 </span>
                    </label>
                  </div>
                </div>
                <div class="col-12 col-lg-4">
                  <div class="mb-3">
                    <label class="form-check">
                      <input class="form-check-input" type="checkbox" id="scraper_nfo_tv_credits_chinese">
                      <span class="form-check-label">演职人员中文 </span>
                    </label>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col">
                  <div class="mb-3">
                    <label class="form-label">电视剧-季-集 </label>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-12 col-lg-4">
                  <div class="mb-3">
                    <label class="form-check">
                      <input class="form-check-input" type="checkbox" id="scraper_nfo_tv_season_basic">
                      <span class="form-check-label">季-基础信息 </span>
                    </label>
                  </div>
                </div>
                <div class="col-12 col-lg-4">
                  <div class="mb-3">
                    <label class="form-check">
                      <input class="form-check-input" type="checkbox" id="scraper_nfo_tv_episode_basic">
                      <span class="form-check-label">集-基础信息 </span>
                    </label>
                  </div>
                </div>
                <div class="col-12 col-lg-4">
                  <div class="mb-3">
                    <label class="form-check">
                      <input class="form-check-input" type="checkbox" id="scraper_nfo_tv_episode_credits">
                      <span class="form-check-label">集-演职人员 </span>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="tab-pane fade" id="tabs-scraper-pic" role="tabpanel">
            <div class="card-body">
              <div class="row">
                <div class="col">
                  <div class="mb-3">
                    <label class="form-label">电影图片 </label>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-12 col-lg-3">
                  <div class="mb-3">
                    <label class="form-check">
                      <input class="form-check-input" type="checkbox" id="scraper_pic_movie_poster">
                      <span class="form-check-label">poster </span>
                    </label>
                  </div>
                </div>
                <div class="col-12 col-lg-3">
                  <div class="mb-3">
                    <label class="form-check">
                      <input class="form-check-input" type="checkbox" id="scraper_pic_movie_backdrop">
                      <span class="form-check-label">fanart </span>
                    </label>
                  </div>
                </div>
                <div class="col-12 col-lg-3">
                  <div class="mb-3">
                    <label class="form-check">
                      <input class="form-check-input" type="checkbox" id="scraper_pic_movie_background">
                      <span class="form-check-label">background </span>
                    </label>
                  </div>
                </div>
                <div class="col-12 col-lg-3">
                  <div class="mb-3">
                    <label class="form-check">
                      <input class="form-check-input" type="checkbox" id="scraper_pic_movie_logo">
                      <span class="form-check-label">logo </span>
                    </label>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-12 col-lg-3">
                  <div class="mb-3">
                    <label class="form-check">
                      <input class="form-check-input" type="checkbox" id="scraper_pic_movie_disc">
                      <span class="form-check-label">disc </span>
                    </label>
                  </div>
                </div>
                <div class="col-12 col-lg-3">
                  <div class="mb-3">
                    <label class="form-check">
                      <input class="form-check-input" type="checkbox" id="scraper_pic_movie_banner">
                      <span class="form-check-label">banner </span>
                    </label>
                  </div>
                </div>
                <div class="col-12 col-lg-3">
                  <div class="mb-3">
                    <label class="form-check">
                      <input class="form-check-input" type="checkbox" id="scraper_pic_movie_thumb">
                      <span class="form-check-label">thumb </span>
                    </label>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col">
                  <div class="mb-3">
                    <label class="form-label">电视剧图片 </label>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-12 col-lg-3">
                  <div class="mb-3">
                    <label class="form-check">
                      <input class="form-check-input" type="checkbox" id="scraper_pic_tv_poster">
                      <span class="form-check-label">poster </span>
                    </label>
                  </div>
                </div>
                <div class="col-12 col-lg-3">
                  <div class="mb-3">
                    <label class="form-check">
                      <input class="form-check-input" type="checkbox" id="scraper_pic_tv_backdrop">
                      <span class="form-check-label">fanart </span>
                    </label>
                  </div>
                </div>
                <div class="col-12 col-lg-3">
                  <div class="mb-3">
                    <label class="form-check">
                      <input class="form-check-input" type="checkbox" id="scraper_pic_tv_background">
                      <span class="form-check-label">background </span>
                    </label>
                  </div>
                </div>
                <div class="col-12 col-lg-3">
                  <div class="mb-3">
                    <label class="form-check">
                      <input class="form-check-input" type="checkbox" id="scraper_pic_tv_logo">
                      <span class="form-check-label">logo </span>
                    </label>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-12 col-lg-3">
                  <div class="mb-3">
                    <label class="form-check">
                      <input class="form-check-input" type="checkbox" id="scraper_pic_tv_clearart">
                      <span class="form-check-label">clearart </span>
                    </label>
                  </div>
                </div>
                <div class="col-12 col-lg-3">
                  <div class="mb-3">
                    <label class="form-check">
                      <input class="form-check-input" type="checkbox" id="scraper_pic_tv_banner">
                      <span class="form-check-label">banner </span>
                    </label>
                  </div>
                </div>
                <div class="col-12 col-lg-3">
                  <div class="mb-3">
                    <label class="form-check">
                      <input class="form-check-input" type="checkbox" id="scraper_pic_tv_thumb">
                      <span class="form-check-label">thumb </span>
                    </label>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col">
                  <div class="mb-3">
                    <label class="form-label">电视剧-季图片 </label>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-12 col-lg-3">
                  <div class="mb-3">
                    <label class="form-check">
                      <input class="form-check-input" type="checkbox" id="scraper_pic_tv_season_poster">
                      <span class="form-check-label">poster </span>
                    </label>
                  </div>
                </div>
                <div class="col-12 col-lg-3">
                  <div class="mb-3">
                    <label class="form-check">
                      <input class="form-check-input" type="checkbox" id="scraper_pic_tv_season_banner">
                      <span class="form-check-label">banner </span>
                    </label>
                  </div>
                </div>
                <div class="col-12 col-lg-3">
                  <div class="mb-3">
                    <label class="form-check">
                      <input class="form-check-input" type="checkbox" id="scraper_pic_tv_season_thumb">
                      <span class="form-check-label">thumb </span>
                    </label>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col">
                  <div class="mb-3">
                    <label class="form-label">电视剧-集图片 </label>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-12 col-lg-3">
                  <div class="mb-3">
                    <label class="form-check">
                      <input class="form-check-input" type="checkbox" id="scraper_pic_tv_episode_thumb"
                        onclick="open_ffmpeg_div('modal_episode_thumb_ffmpeg')">
                      <span class="form-check-label">thumb <span class="form-help" title="开启后将查询TMDB生成集缩略图"
                          data-bs-toggle="tooltip">?</span></span>
                    </label>
                  </div>
                </div>
                <div class="col-12 col-lg-3 d-none"
                  id="modal_episode_thumb_ffmpeg">
                  <div class="mb-3">
                    <label class="form-check">
                      <input class="form-check-input" type="checkbox" id="scraper_pic_tv_episode_thumb_ffmpeg">
                      <span class="form-check-label">thumb-ffmpeg <span class="form-help"
                          title="开始后，如TMDB无数据则读取视频文件生成（需要ffmpeg，最新完整版Docker镜像已包含，lite版本镜像默认不支持该功能）"
                          data-bs-toggle="tooltip">?</span></span>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-link" data-bs-dismiss="modal">取消</button>
        <a id="scraper_save_btn" href="javascript:save_scraper_config()" class="btn btn-primary ms-auto">
          保存
        </a>
      </div>
    </div>
  </div>
</div>

<div class="modal modal-blur fade" id="modal-library-category" tabindex="-1" role="dialog" aria-hidden="true"
  data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">二级分类配置</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="form-control" id="library_category_config" style="height: calc(100vh - 20rem);"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-link me-auto" data-bs-dismiss="modal">取消</button>
        <a href="javascript:save_category_config()" id="library_category_save_btn" class="btn btn-primary">保存</a>
      </div>
    </div>
  </div>
</div>


<script type="text/javascript">
  
  // 打开新增窗口
  function show_directory_modal(type) {
    $("#path_type").val(type);
    $("#modal-dirctory").modal('show');
  }

  // 新增目录
  function add_directory_config() {
    const type = $("#path_type").val();
    const value = $("#path_str").val();
    const params = { "oper": "add", "key": "media." + type + "_path", "value": value };
    $("#modal-dirctory").modal('hide');
    axios_post_do("update_directory", params, function (ret) {
      window_history_refresh();
    });
  }

  // 删除目录
  function sub_directory_config(type, value) {
    const params = { "oper": "sub", "key": "media." + type + "_path", "value": value };
    axios_post_do("update_directory", params, function (ret) {
      window_history_refresh();
    });
  }

  // 保存基础设置
  function save_basic_config(type, flag = true) {
    let params = input_select_GetVal(type);
    if (params["media.category"] === "config") {
      show_warning_modal("非法二级分类策略名称");
      return;
    }
    if (flag) {
      $("#" + type + "_btn").text("保存中...").attr("disabled", true);
    }
    axios_post_do("update_config", params, function (ret) {
      if (flag) {
        $("#" + type + "_btn").text("保存").attr("disabled", false);
        // window_history_refresh();
        show_success_modal("配置已保存!");
      }
    });
  }


  // 保存刮削配置
  function save_scraper_config() {

    let params = {
      "key": "UserScraperConf",
      "value": {
        scraper_nfo: {
          movie: {
            basic: $("#scraper_nfo_movie_basic").prop('checked'),
            credits: $("#scraper_nfo_movie_credits").prop('checked'),
            credits_chinese: $("#scraper_nfo_movie_credits_chinese").prop('checked'),
          },
          tv: {
            basic: $("#scraper_nfo_tv_basic").prop('checked'),
            credits: $("#scraper_nfo_tv_credits").prop('checked'),
            credits_chinese: $("#scraper_nfo_tv_credits_chinese").prop('checked'),
            season_basic: $("#scraper_nfo_tv_season_basic").prop('checked'),
            episode_basic: $("#scraper_nfo_tv_episode_basic").prop('checked'),
            episode_credits: $("#scraper_nfo_tv_episode_credits").prop('checked'),
          }
        },
        scraper_pic: {
          movie: {
            poster: $("#scraper_pic_movie_poster").prop('checked'),
            backdrop: $("#scraper_pic_movie_backdrop").prop('checked'),
            background: $("#scraper_pic_movie_background").prop('checked'),
            logo: $("#scraper_pic_movie_logo").prop('checked'),
            disc: $("#scraper_pic_movie_disc").prop('checked'),
            banner: $("#scraper_pic_movie_banner").prop('checked'),
            thumb: $("#scraper_pic_movie_thumb").prop('checked'),
          },
          tv: {
            poster: $("#scraper_pic_tv_poster").prop('checked'),
            backdrop: $("#scraper_pic_tv_backdrop").prop('checked'),
            background: $("#scraper_pic_tv_background").prop('checked'),
            logo: $("#scraper_pic_tv_logo").prop('checked'),
            clearart: $("#scraper_pic_tv_clearart").prop('checked'),
            banner: $("#scraper_pic_tv_banner").prop('checked'),
            thumb: $("#scraper_pic_tv_thumb").prop('checked'),
            season_poster: $("#scraper_pic_tv_season_poster").prop('checked'),
            season_banner: $("#scraper_pic_tv_season_banner").prop('checked'),
            season_thumb: $("#scraper_pic_tv_season_thumb").prop('checked'),
            episode_thumb: $("#scraper_pic_tv_episode_thumb").prop('checked'),
            episode_thumb_ffmpeg: $("#scraper_pic_tv_episode_thumb_ffmpeg").prop('checked')
          }
        }
      }
    };
    axios_post_do("set_system_config", params, function (ret) {
      $("#modal-scraper").modal("hide");
      window_history_refresh();
    });
  }

  // 选中电视剧-集图片thumb，显示ffmpeg
  function open_ffmpeg_div(div_id) {
    let ffmpeg_container = $("#" + div_id);
    let ffmpeg_check = ffmpeg_container.find("input[type='checkbox']");
    if (ffmpeg_container.hasClass("d-none")) {
      ffmpeg_container.removeClass("d-none");
    } else {
      ffmpeg_container.addClass("d-none");
      ffmpeg_check.prop("checked", false);
    }
  }

  // 显示二级分类编辑框
  function show_category_config_modal() {
    let category_name = $("[name=category_name]").val();
    if (!category_name) {
      show_warning_modal("请先输入二级分类策略名称");
      return;
    }
    if (category_name === "config") {
      show_warning_modal("非法二级分类策略名称");
      return;
    }
    axios_post_do("get_category_config", { "category_name": category_name }, function (ret) {
      if (ret.code === 0) {
        category_editor.setValue(ret.text);
        $("#modal-library-category").modal('show');
      } else {
        show_warning_modal(ret.msg);
      }
    });
  }

  // 保存二级分类配置
  function save_category_config() {
    const value = category_editor.getValue();
    const params = { "config": value };
    axios_post_do("update_category_config", params, function (ret) {
      $("#modal-library-category").modal('hide');
    });
  }

  // 设置刮削器配置复选框状态
  function setScraperCheckboxes(scraperNfo, scraperPic) {
      // NFO 配置
      if (scraperNfo) {
        // 电影 NFO
        if (scraperNfo.movie) {
          $('#scraper_nfo_movie_basic').prop('checked', !!scraperNfo.movie.basic);
          $('#scraper_nfo_movie_credits').prop('checked', !!scraperNfo.movie.credits);
          $('#scraper_nfo_movie_credits_chinese').prop('checked', !!scraperNfo.movie.credits_chinese);
        }

        // 电视剧 NFO
        if (scraperNfo.tv) {
          $('#scraper_nfo_tv_basic').prop('checked', !!scraperNfo.tv.basic);
          $('#scraper_nfo_tv_credits').prop('checked', !!scraperNfo.tv.credits);
          $('#scraper_nfo_tv_credits_chinese').prop('checked', !!scraperNfo.tv.credits_chinese);
          $('#scraper_nfo_tv_season_basic').prop('checked', !!scraperNfo.tv.season_basic);
          $('#scraper_nfo_tv_episode_basic').prop('checked', !!scraperNfo.tv.episode_basic);
          $('#scraper_nfo_tv_episode_credits').prop('checked', !!scraperNfo.tv.episode_credits);
        }
      }

      // 图片配置
      if (scraperPic) {
        // 电影图片
        if (scraperPic.movie) {
          $('#scraper_pic_movie_poster').prop('checked', !!scraperPic.movie.poster);
          $('#scraper_pic_movie_backdrop').prop('checked', !!scraperPic.movie.backdrop);
          $('#scraper_pic_movie_background').prop('checked', !!scraperPic.movie.background);
          $('#scraper_pic_movie_logo').prop('checked', !!scraperPic.movie.logo);
          $('#scraper_pic_movie_disc').prop('checked', !!scraperPic.movie.disc);
          $('#scraper_pic_movie_banner').prop('checked', !!scraperPic.movie.banner);
          $('#scraper_pic_movie_thumb').prop('checked', !!scraperPic.movie.thumb);
        }

        // 电视剧图片
        if (scraperPic.tv) {
          $('#scraper_pic_tv_poster').prop('checked', !!scraperPic.tv.poster);
          $('#scraper_pic_tv_backdrop').prop('checked', !!scraperPic.tv.backdrop);
          $('#scraper_pic_tv_background').prop('checked', !!scraperPic.tv.background);
          $('#scraper_pic_tv_logo').prop('checked', !!scraperPic.tv.logo);
          $('#scraper_pic_tv_clearart').prop('checked', !!scraperPic.tv.clearart);
          $('#scraper_pic_tv_banner').prop('checked', !!scraperPic.tv.banner);
          $('#scraper_pic_tv_thumb').prop('checked', !!scraperPic.tv.thumb);
          $('#scraper_pic_tv_season_poster').prop('checked', !!scraperPic.tv.season_poster);
          $('#scraper_pic_tv_season_banner').prop('checked', !!scraperPic.tv.season_banner);
          $('#scraper_pic_tv_season_thumb').prop('checked', !!scraperPic.tv.season_thumb);
          $('#scraper_pic_tv_episode_thumb').prop('checked', !!scraperPic.tv.episode_thumb);

          // 控制 episode_thumb_ffmpeg 区域的显示
          if (scraperPic.tv.episode_thumb) {
            $('#modal_episode_thumb_ffmpeg').removeClass('d-none');
          } else {
            $('#modal_episode_thumb_ffmpeg').addClass('d-none');
          }
        }
      }
    }

  var target_theme = localStorage.getItem("theme") === "dark" ? "ace/theme/one_dark" : "ace/theme/xcode";
  // yaml编辑器
  category_editor = ace.edit("library_category_config");
  category_editor.setTheme(target_theme);
  category_editor.session.setMode("ace/mode/yaml");
  category_editor.setOptions({
    fontFamily: "Consolas, Monaco, monospace",
    fontSize: "10pt"
  });

</script>


<script type="text/javascript">

  var configInfo = {};

  // 渲染媒体库目录
  function renderLibraries() {
    const types = { movie: "电影", tv: "电视剧", anime: "动漫", unknown: "未识别" };
    let $list = $("#library-list");

    $.each(types, function (type, title) {

      var rows = "";
      if (configInfo.media[type + "_path"] && configInfo.media[type + "_path"].length > 0) {
        $.each(configInfo.media[type + "_path"], function (i, path) {
          rows += `
            <tr>
              <td><input type="hidden" value="${path}">${path}</td>
              <td><a href="javascript:sub_directory_config('${type}','${path}')" title="删除目录"><i class="ti ti-x fs-2 text-danger"></i></a></td>
            </tr>`;
        });
      } else {
        rows = `<tr><td colspan="2" align="center">未配置</td></tr>`;
      }

      $list.append(`
          <div class="card align-self-start">
            <div class="card-header">
              <h3 class="card-title"><strong>${title}目录</strong></h3>
              <div class="card-actions btn-actions">
                <a href="javascript:show_directory_modal('${type}')" class="btn-action ms-auto"><i class="ti ti-plus fs-2"></i></a>
                <a href="javascript:slideToggle('library-list-${type}')" class="btn-action ms-1" title="展开/折叠">
                  <i class="ti ti-menu-2 fs-2"></i>
                </a>
              </div>
            </div>
            <div class="table-responsive" id="library-list-${type}">
              <table class="mb-4 card-table table text-nowrap table-hover">
                <thead><tr><th>目录</th><th class="w-3"></th></tr></thead>
                <tbody>${rows}</tbody>
              </table>
            </div>
          </div>
      `);
    });
  }

  // 页面初始化
  $(document).ready(function () {

    // 使用axios_post请求/data/library接口获取数据并填充页面
    axios_post('/data/library', {}, function(response) {
      if (response.code === 0 && response.data) {
        const data = response.data;

        if (data.Config) {
          configInfo = data.Config;
        }

        // 渲染页面
        renderLibraries();

        // 设置刮削器配置复选框状态
        setScraperCheckboxes(data.ScraperNfo, data.ScraperPic);

        // 填充媒体设置数据
        if (data.Config && data.Config.media) {
          $('#media\\.mediasync_interval').val(data.Config.media.mediasync_interval || '');
          $('#media\\.media_default_path').val(data.Config.media.media_default_path || '');
          $('#media\\.category').val(data.Config.media.category || '');
          $('#media\\.default_rmt_mode').val(data.Config.media.default_rmt_mode || '');
          $('#media\\.min_filesize').val(data.Config.media.min_filesize || '');
          $('#media\\.ignored_paths').val(data.Config.media.ignored_paths || '');
          $('#media\\.ignored_files').val(data.Config.media.ignored_files || '');
          $('#media\\.movie_name_format').val(data.Config.media.movie_name_format || '');
          $('#media\\.tv_name_format').val(data.Config.media.tv_name_format || '');
          $('#media\\.tmdb_language').val(data.Config.media.tmdb_language || 'zh');
          $('#media\\.filesize_cover').prop('checked', data.Config.media.filesize_cover || false);
          $('#media\\.nfo_poster').prop('checked', data.Config.media.nfo_poster || false);
        }

        // 填充转移模式选项
        if (data.RmtModeDict) {

          const rmtModeSelect = $('#media\\.default_rmt_mode');
          rmtModeSelect.empty();

          const syncModSelect = $('#sync_path_syncmod');
          syncModSelect.empty();

          data.RmtModeDict.forEach(function(mode) {

            const selected = data.Config && data.Config.media && data.Config.media.default_rmt_mode === mode.value ? 'selected' : '';
            rmtModeSelect.append(`<option value="${mode.value}" ${selected}>${mode.name}</option>`);

            syncModSelect.append(`<option value="${mode.value}">${mode.name}</option>`);

          });

        }

      }
    });
  });

</script>