<div class="page-body">
  <div class="container-xl">
    <div class="row row-cards" id="library-list">
      <!-- JS 动态填充 -->
    </div>
  </div>
</div>

<div class="modal modal-blur fade" id="modal-dirctory" tabindex="-1" role="dialog" aria-hidden="true"
  data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">新增目录</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-lg-12">
            <div class="mb-3">
              <label class="form-label">路径 <span class="form-help"
                  title="Emby/Jellyfin/Plex媒体库对应文件的路径，下载文件转移、目录同步未配置目的目录时，媒体文件将重命名转移到该目录"
                  data-bs-toggle="tooltip">?</span></label>
              <input type="text" value="" id="path_str" class="form-control filetree-folders-only" autocomplete="off">
              <input type="hidden" value="" id="path_type" class="form-control">
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-link me-auto" data-bs-dismiss="modal">取消</button>
        <a href="javascript:add_directory_config()" id="directory_save_btn" class="btn btn-primary">确定</a>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
  
  // 打开新增窗口
  function show_directory_modal(type) {
    $("#path_type").val(type);
    $("#modal-dirctory").modal('show');
  }

  // 新增目录
  function add_directory_config() {
    const type = $("#path_type").val();
    const value = $("#path_str").val();
    const params = { "oper": "add", "key": "media." + type + "_path", "value": value };
    $("#modal-dirctory").modal('hide');
    axios_post_do("update_directory", params, function (ret) {
      window_history_refresh();
    });
  }

  // 删除目录
  function sub_directory_config(type, value) {
    const params = { "oper": "sub", "key": "media." + type + "_path", "value": value };
    axios_post_do("update_directory", params, function (ret) {
      window_history_refresh();
    });
  }

</script>

<script type="text/javascript">
  // === 1. 注入数据 (后端 JSON 渲染) ===

  var configInfo = {};

  // 渲染媒体库目录
  function renderLibraries() {
    const types = { movie: "电影", tv: "电视剧", anime: "动漫", unknown: "未识别" };
    let $list = $("#library-list");

    $.each(types, function (type, title) {
      let rows = "";
      if (configInfo.media[type + "_path"] && configInfo.media[type + "_path"].length > 0) {
        $.each(configInfo.media[type + "_path"], function (i, path) {
          rows += `
            <tr>
              <td><input type="hidden" value="${path}">${path}</td>
              <td><a href="javascript:sub_directory_config('${type}','${path}')" title="删除目录"><i class="ti ti-x fs-2"></i></a></td>
            </tr>`;
        });
      } else {
        rows = `<tr><td colspan="2" align="center">未配置</td></tr>`;
      }

      $list.append(`
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title"><strong>${title}</strong></h3>
              <a href="javascript:show_directory_modal('${type}')" class="btn btn-primary btn-icon ms-auto"><i class="ti ti-plus fs-2"></i></a>
            </div>
            <div class="table-responsive">
              <table class="table card-table table-vcenter text-nowrap datatable table-hover table-striped">
                <thead><tr><th>目录</th><th class="w-3"></th></tr></thead>
                <tbody>${rows}</tbody>
              </table>
            </div>
          </div>
        </div>
      `);
    });
  }

  // === 5. 页面初始化 ===
  $(document).ready(function () {

    // 使用axios_post请求/data/library接口获取数据并填充页面
    axios_post('/data/library', {}, function(response) {
      if (response.code === 0 && response.data) {
        const data = response.data;

        if (data.Config) {
          configInfo = data.Config;
        }

        // 渲染页面
        renderLibraries();
      }
    }, true, true);
  });

</script>