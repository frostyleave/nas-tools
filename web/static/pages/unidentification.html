<div class="container-xl">
  <div class="page-header d-print-none mt-2">
    <div class="row align-items-center">
      <div class="col">
        <h2 class="page-title">手动识别</h2>
      </div>
      <div class="col-auto ms-auto d-print-none">
        <div class="btn-list">
          <a href="javascript:show_rename_udf_modal()" class="btn btn-primary d-none d-sm-inline-flex">
            <i class="ti ti-transform fs-3"></i>
            自定义识别
          </a>
          <a href="javascript:show_rename_udf_modal()" class="btn btn-primary d-sm-none mbtn-action">
            <i class="ti ti-transform fs-3"></i>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- 业务页面代码 -->
<div class="page-body">
  <div class="container-xl">
    <div class="row row-cards">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header">
            <div class="d-flex">
              <div class="text-muted">
                共 <span id="total-count">0</span> 条记录<span class="d-none d-md-inline-block"> ，搜索：</span>
              </div>
              <div class="ms-auto text-muted">
                <div class="ms-2 d-none d-md-inline-block">
                  <input id="search_word" value="" type="text" class="form-control form-control-sm"
                         aria-label="搜索">
                </div>
              </div>
            </div>
            <div class="card-actions">
              <a href="javascript:reidentification_all()" class="btn d-none d-md-inline-flex" title="重新识别">
                <i class="ti ti-refresh fs-2"></i>
                重新识别
              </a>
              <a href="javascript:reidentification_all()" class="btn-action d-md-none" title="重新识别">
                <i class="ti ti-refresh fs-2"></i>
              </a>
              <a href="javascript:delete_checked_unknown()" class="btn text-danger d-none d-md-inline-flex" title="批量删除">
                <i class="ti ti-trash fs-2"></i>
                批量删除
              </a>
              <a href="javascript:delete_checked_unknown()" class="btn-action text-danger d-md-none" title="批量删除">
                <i class="ti ti-trash fs-2"></i>
              </a>
            </div>
          </div>
          <div class="table-responsive" id="table-container">
            <table class="table table-vcenter card-table table-hover table-striped">
              <thead>
              <tr id="table-header">
                <th>文件名</th>
                <th class="w-5">转移方式</th>
                <th class="w-5"></th>
              </tr>
              </thead>
              <tbody id="unidentification-table-body">
                <tr>
                  <td colspan="3" align="center">加载中...</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="card-footer d-flex align-items-center" id="pagination-container" style="display: none;">
            <p class="m-0 text-muted">当前页 <span id="current-count">0</span> 条</p>
            <ul class="pagination m-0 ms-auto" id="pagination-list">
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
  // 上一页
  function go_pre_page(search, page) {
    navmenu("unidentification?s=" + search + "&page=" + (page - 1))
  }

  // 下一页
  function go_next_page(search, page) {
    navmenu("unidentification?s=" + search + "&page=" + (page + 1))
  }

  // 搜索按钮
  $('#search_word').bind('keypress', function (event) {
    if (event.keyCode == "13") {
      const keyword = $("#search_word").val();
      navmenu("unidentification?s=" + keyword);
    }
  });

  //显示弹出窗口
  function show_rename_modal(id, path, rmt_mode) {
    show_manual_transfer_modal(1, path, rmt_mode, '', id, '');
  }

  //显示自定义识别窗口
  function show_rename_udf_modal() {
    show_manual_transfer_modal(3, '', '', '', '', '');
  }

  //删除路径
  function del_unknown_path(id) {
    if (id == "") {
      return;
    }
    const cmd = "del_unknown_path";
    const data = {"id": id};
    axios_post_do(cmd, data, function (ret) {
      window_history_refresh();
    });
  }


  //批量删除
  function delete_checked_unknown() {
    let logids = select_GetSelectedVAL("unknow_record");
    if (logids.length === 0) {
      return;
    }
    show_confirm_modal("是否确认删除所有选中的未识别记录？", function () {
      hide_confirm_modal();
      axios_post_do("del_unknown_path", {"id": logids}, function (ret) {
        window_history_refresh();
      });
    })
  }

  //批量重新识别
  function reidentification_all() {
    let logids = select_GetSelectedVAL("unknow_record");
    if (logids.length === 0) {
      return;
    }
    re_identification("unidentification", logids);
  }

</script>

<script type="text/javascript">
  
  // 页面加载完成后，使用axios_post请求/data/unidentification接口获取数据并填充页面
  $(document).ready(function() {

    // 获取URL参数
    const [path, queryString] = window.location.hash.split("?");
    const urlParams = new URLSearchParams(queryString);
    const searchKeyword = urlParams.get('s') || '';
    const currentPage = urlParams.get('page') || 1;
    const pageNum = 20;

    // 设置搜索框的值
    $('#search_word').val(searchKeyword);

    const requestData = {};
    requestData.pagenum = pageNum;
    requestData.s = searchKeyword;
    requestData.page = currentPage;

    axios_post('/data/unidentification', requestData, function(response) {

      if (response.code === 0 && response.data) {

        const data = response.data;

        // 更新总记录数
        $('#total-count').text(data.TotalCount || 0);
        $('#current-count').text(data.Count || 0);

        // 生成未识别文件表格
        const tableBody = $('#unidentification-table-body');
        const tableHeader = $('#table-header');
        const tableContainer = $('#table-container');
        const paginationContainer = $('#pagination-container');

        tableBody.empty();

        if (data.Items && data.Items.length > 0) {
          // 添加复选框列头
          if (data.TotalCount > 0) {
            tableHeader.prepend(`
              <th class="w-1">
                <input class="form-check-input m-0 align-middle" type="checkbox" aria-label="全选"
                       onclick="select_SelectALL($(this).prop('checked'), 'unknow_record')">
              </th>
            `);
            tableContainer.addClass('table-page-body');
          }

          data.Items.forEach(path => {
            const pathEncoded = path.name ? path.name.replace(/\\/g, '/') : '';
            const toPath = path.to ? `<div class="text-muted">=> ${path.to}</div>` : '';

            const row = `
              <tr>
                <td>
                  <input class="form-check-input m-0 align-middle" name="unknow_record" value="${path.id}" type="checkbox">
                </td>
                <td>
                  <a href='javascript:navmenu("mediafile?dir=${pathEncoded}")'>${path.name}</a>
                  ${toPath}
                </td>
                <td>
                  <div class="text-muted">
                    ${path.sync_mode}
                  </div>
                </td>
                <td>
                  <div class="dropdown">
                    <a href="#" class="btn-action" data-bs-toggle="dropdown" aria-expanded="false">
                      <i class="ti ti-dots-vertical fs-2"></i>
                    </a>
                    <div class="dropdown-menu dropdown-menu-end">
                      <a class="dropdown-item" href='javascript:re_identification("unidentification", ["${path.id}"])'>
                        重新识别
                      </a>
                      <a class="dropdown-item" href='javascript:show_rename_modal("${path.id}", "${path.name}", "${path.rmt_mode}")'>
                        手动识别
                      </a>
                      <a class="dropdown-item text-danger" href='javascript:del_unknown_path("${path.id}")'>
                        删除
                      </a>
                    </div>
                  </div>
                </td>
              </tr>
            `;
            tableBody.append(row);
          });

          // 生成分页
          if (data.TotalCount > 0) {
            const paginationList = $('#pagination-list');
            paginationList.empty();

            // 上一页
            const prevDisabled = data.CurrentPage == 1 ? 'disabled' : '';
            paginationList.append(`
              <li class="page-item ${prevDisabled}">
                <a class="page-link" href="javascript:go_pre_page('${data.Search || ''}', ${data.CurrentPage})" tabindex="-1" aria-disabled="true">
                  <i class="ti ti-chevron-left"></i>
                </a>
              </li>
            `);

            var total_page = (data.TotalCount + pageNum - 1) / pageNum;
            var page_range = get_page_range(data.CurrentPage, total_page);

            // 页码
            page_range.forEach(page => {
              const active = page == data.CurrentPage ? 'active' : '';
              paginationList.append(`
                <li class="page-item ${active}">
                  <a class="page-link" href="javascript:navmenu('unidentification?s=${data.Search || ''}&page=${page}')">${page}</a>
                </li>
              `);
            });

            // 下一页
            const nextDisabled = data.CurrentPage >= data.TotalPage ? 'disabled' : '';
            const nextHref = data.CurrentPage < data.TotalPage ?
              `javascript:go_next_page('${data.Search || ''}', ${data.CurrentPage})` :
              'javascript:void(0)';
              
            paginationList.append(`
              <li class="page-item ${nextDisabled}">
                <a class="page-link" href="${nextHref}">
                  <i class="ti ti-chevron-right"></i>
                </a>
              </li>
            `);

            paginationContainer.show();
          }
        } else {
          // 没有数据
          tableBody.append(`
            <tr>
              <td colspan="3" align="center">没有数据</td>
            </tr>
          `);
        }
      }
    }, true, true);
  });

</script>